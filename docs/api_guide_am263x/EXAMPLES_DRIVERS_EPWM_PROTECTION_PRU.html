<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM263x MCU+ SDK: EPWM protection solution using PRU</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM263x MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM263x MCU+ SDK
   &#160;<span id="projectnumber">11.00.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('EXAMPLES_DRIVERS_EPWM_PROTECTION_PRU.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">EPWM protection solution using PRU </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md2336">Introduction</a><ul><li class="level2"><a href="#autotoc_md2337">Inputs</a></li>
<li class="level2"><a href="#autotoc_md2338">Outputs</a></li>
<li class="level2"><a href="#autotoc_md2339">Implementation</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md2340">External Connections</a><ul><li class="level2"><a href="#autotoc_md2341">AM263X-CC or AM263PX-CC or AM261X-SOM</a></li>
<li class="level2"><a href="#autotoc_md2342">AM263X-LP or AM263PX-LP or AM261X-LP</a></li>
</ul>
</li>
<li class="level1"><a href="#EXAMPLES_DRIVERS_EPWM_PROTECTION_PRU_COMBOS">Supported Combinations</a></li>
<li class="level1"><a href="#autotoc_md2343">Steps to Run the Example</a></li>
<li class="level1"><a href="#autotoc_md2344">See Also</a></li>
<li class="level1"><a href="#autotoc_md2345">Sample Output</a><ul><li class="level2"><a href="#autotoc_md2346">Waveforms</a></li>
<li class="level2"><a href="#autotoc_md2347">Benchmarks</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md2348">References</a><ul><li class="level2"><a href="#autotoc_md2349">ICSS connectivity</a></li>
<li class="level2"><a href="#autotoc_md2350">AM263x XBARs</a></li>
<li class="level2"><a href="#autotoc_md2351">AM263x EPWM Digital Compare and Trip Zone module</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_examples_drivers_epwm_protection_pru"></a></p>
<h1><a class="anchor" id="autotoc_md2336"></a>
Introduction</h1>
<p>This example shows:</p><ul>
<li>Support for PWM protection solution using PRU ICSS<ul>
<li>ICSS PRU to latch, CPU (R5F) to clear the PWM protection status</li>
</ul>
</li>
<li>Waveforms for PWM protection status, transition from normal to protection status</li>
<li>Benchmark for ASC shutdown delay time (time from trip signal to PWM output entering protection status).</li>
<li>Configurable deadband time in normal PWM output.<ul>
<li>No deadband time needed during changing from freewheeling to H-ASC or L-ASC</li>
</ul>
</li>
<li>Configurable Freewheeling time.</li>
</ul>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig1a.png"]{width:40%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig1a.png" alt=""/>
<div class="caption">
Figure 1a. PWM protection example - Block Diagram</div></div>
<h2><a class="anchor" id="autotoc_md2337"></a>
Inputs</h2>
<ul>
<li>IGBT Fault signal<ul>
<li>Digital Signal , e.g.1&ndash; Low side IGBT has issue, 0&ndash; no issue.</li>
</ul>
</li>
<li>OCP Signal<ul>
<li>Over Current protection ,Digital Signal e.g. 1&ndash; Over current , 0 &ndash; current normal.</li>
</ul>
</li>
<li>OVP Signal<ul>
<li>Over Voltage protection, Digital Signal e.g. 1&ndash; Over voltage , 0 &ndash;voltage normal.</li>
</ul>
</li>
<li>For the speed threshold, 2 cases<ul>
<li>Case 1 (not implemented by this example): Speed Signal: is PWM signal, PWM frequency corresponding to motor Speed. Calculate the motor speed based on this PWM frequency and judge the speed &gt; Threshold or not.</li>
<li>Case 2: Speed Level : IO signal ,e.g. 1&ndash;Speed &gt; high Threshold, 0&ndash; Speed &lt; high Threshold.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md2338"></a>
Outputs</h2>
<p>Flowchart for expected output/PWM protection behavior</p>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig2a.png"]{width:40%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig2a.png" alt=""/>
<div class="caption">
Figure 2a. Protection flow chart</div></div>
<p>Truth table equivalent of protection flowchart </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Speed level/Speed Signal  </th><th class="markdownTableHeadNone">IGBT fault signal  </th><th class="markdownTableHeadNone">OVP signal  </th><th class="markdownTableHeadNone">OCP signal  </th><th class="markdownTableHeadNone">PWM behavior/status   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0 (Speed &lt; high Threshold)  </td><td class="markdownTableBodyNone">X  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">Normal PWM output   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0 (Speed &lt; high Threshold)  </td><td class="markdownTableBodyNone">X  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">Shut down all PWM   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0 (Speed &lt; high Threshold)  </td><td class="markdownTableBodyNone">X  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">Shut down all PWM   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0 (Speed &lt; high Threshold)  </td><td class="markdownTableBodyNone">X  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">Shut down all PWM   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1 (Speed &gt; high Threshold)  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">Normal PWM output   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">1 (Speed &gt; high Threshold)  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">Shut down all PWM   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1 (Speed &gt; high Threshold)  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">Low side ASC   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">1 (Speed &gt; high Threshold)  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">Low side ASC   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1 (Speed &gt; high Threshold)  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">Normal PWM output   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">1 (Speed &gt; high Threshold)  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">Shut down all PWM   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1 (Speed &gt; high Threshold)  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">High side ASC   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">1 (Speed &gt; high Threshold)  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">High side ASC   </td></tr>
</table>
<ul>
<li>To ensure transition from normal to shut down: Speed level must be updated first followed by OCP, OVP and then IGBT</li>
<li>To ensure transition from normal to low/high ASC: Speed level must be updated first followed by IGBT fault signal, OVP and then OCP</li>
</ul>
<p>Details of PWM behavior/status</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">PWM behavior/status  </th><th class="markdownTableHeadNone">Details   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Normal PWM output  </td><td class="markdownTableBodyNone">Normal operation of <br  />
 PWM0/1/2_A,<br  />
 PWM0/1/2_B   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Shut down all PWM  </td><td class="markdownTableBodyNone">PWM0/1/2_A trips to low (0% duty), <br  />
 PWM0/1/2_B trips to low (0% duty)   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Low side ASC, <br  />
 Three low side PWM 100% duty ON, <br  />
 three high side PWM shunt down  </td><td class="markdownTableBodyNone">PWM0/1/2_A trips to low (0% duty), <br  />
 PWM0/1/2_B trips to high (100% duty)   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">High side ASC, <br  />
 Three high side PWM 100% duty ON, <br  />
 three Low side PWM shunt down  </td><td class="markdownTableBodyNone">PWM0/1/2_A trips to high (100% duty), <br  />
 PWM0/1/2_B trips to low (0% duty)   </td></tr>
</table>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig2b.png"]{width:100%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig2b.png" alt=""/>
<div class="caption">
Figure 2b. Normal PWM output to Low side ASC, Normal PWM output to High side ASC</div></div>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig2c.png"]{width:100%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig2c.png" alt=""/>
<div class="caption">
Figure 2c. Normal PWM output to shut down</div></div>
<h2><a class="anchor" id="autotoc_md2339"></a>
Implementation</h2>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig3a.png"]{width:100%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig3a.png" alt=""/>
<div class="caption">
Figure 3a. Implementation block diagram</div></div>
<p>Signal path: GPIO51/52/53/54 -&gt; INPUTXBAR0/1/2/3 -&gt; PWMXBAR0/1/2/3 -&gt; GPI0/1/2/3 ICSS (PRU firmware reads GPI reg, process, writes to GPO reg) GPO0/1/2/3 -&gt; INPUTXBAR4/5/6/7 -&gt; PWMXBAR4/5/6/7 -&gt; EPWM0+1+2 Trip5/6/7/8</p>
<ul>
<li>No setup for GPIO51/52/53/54 required to feed input to InputXbar</li>
<li>INPUTXBAR0/1/2/3 configured to select its inputs as GPIO51/52/53/54 respectively</li>
<li>PWMXBAR0/1/2/3 configured to select its inputs as INPUTXBAR0/1/2/3 respectively</li>
<li>ICSS GPI MUX configured to select PWMXBAR0/1/2/3 as input for ICSS GPI0/1/2/3 respectively</li>
<li>Details of PRU firmware below</li>
<li>INPUTXBAR4/5/6/7 configured to select its inputs as ICSS GPO0/1/2/3 respectively</li>
<li>PWMXBAR4/5/6/7 configured to select its inputs as INPUTXBAR4/5/6/7 respectively</li>
<li>PWMXBAR4/5/6/7 feeds to EPWM trip inputs</li>
<li>EPWM setup:<ul>
<li>EPWM0 (used for PWM0_A and PWM0_B)<ul>
<li>Frequency: 20KHz</li>
<li>Left aligned</li>
<li>PWM_A duty: 70%</li>
<li>Deadband settings: Active High Complementary. RED, FED: 100 (500ns)</li>
<li>PWM_A and PWM_B complementary</li>
</ul>
</li>
<li>EPWM1 (used for PWM1_A and PWM1_B)<ul>
<li>Frequency: 20KHz</li>
<li>Left aligned</li>
<li>PWM_A duty: 70%</li>
<li>Deadband settings: Active High Complementary. RED, FED: 100 (500ns)</li>
<li>PWM_A and PWM_B complementary</li>
</ul>
</li>
<li>EPWM2 (used for PWM2_A and PWM2_B)<ul>
<li>Frequency: 20KHz</li>
<li>Left aligned</li>
<li>PWM_A duty: 70%</li>
<li>Deadband settings: Active High Complementary. RED, FED: 100 (500ns)</li>
<li>PWM_A and PWM_B complementary</li>
</ul>
</li>
</ul>
</li>
<li>EPWM trip setup:<ul>
<li>TripInput5 -&gt; DCAH, DCAH high -&gt; DCAEVT1, DCAEVT1 -&gt; Trip EPWM0_A high</li>
<li>TripInput6 -&gt; DCAL, DCAL high -&gt; DCAEVT2, DCAEVT2 -&gt; Trip EPWM0_A low</li>
<li>TripInput7 -&gt; DCBH, DCBH high -&gt; DCBEVT1, DCBEVT1 -&gt; Trip EPWM0_B high</li>
<li>TripInput8 -&gt; DCBL, DCBL high -&gt; DCBEVT2, DCBEVT2 -&gt; Trip EPWM0_B low</li>
</ul>
</li>
</ul>
<p>ICSS PRU firmware:</p>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig3b.png"]{width:100%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig3b.png" alt=""/>
<div class="caption">
Figure 3b. Implementation flow chart</div></div>
<div class="fragment"><div class="line">    .retain     ; Required for building .out with assembly file</div>
<div class="line">    .retainrefs ; Required for building .out with assembly file</div>
<div class="line"> </div>
<div class="line">    .global     main</div>
<div class="line">    .sect       &quot;.text&quot;</div>
<div class="line"> </div>
<div class="line">    .asg    r31,    gpi_reg</div>
<div class="line">    .asg    r30,    gpo_reg</div>
<div class="line">    .asg    r1.b0,  offset_reg8</div>
<div class="line">    .asg    r20,    temp_reg32</div>
<div class="line">    .asg    r21.b0, input_bits_reg8</div>
<div class="line">    .asg    r22.b0, trip_bits_reg8</div>
<div class="line">    .asg    r23.b0, clr_reg8</div>
<div class="line">    .asg    r24.b0, zero_reg8</div>
<div class="line">    .asg    r25,    freewheeling_countdown_reg32</div>
<div class="line">    .asg    r26,    freewheeling_time_reg32</div>
<div class="line">    .asg    0,      LUT_OFFSET                                      ; 16 byte.  Offset of Look up table for PRU FW use. Placed at base of PRU DMEM0 - as optimization</div>
<div class="line">                                                                    ;           Initialize before PRU FW load and run</div>
<div class="line">    .asg    16,     PROTECTION_STATUS_OFFSET                        ; 1 byte.   Offset of Protection status from PRU</div>
<div class="line">    .asg    20,     PROTECTION_STATUS_CLR_OFFSET                    ; 1 byte.   Offset of Clear request from R5</div>
<div class="line">    .asg    24,     PRU_FW_VERSION_OFFSET                           ; 4 byte.   Offset of PRU firmware version</div>
<div class="line">    .asg    28,     FREEWHEELING_TIME_OFFSET                        ; 4 byte.   Offset of Freewheeling time</div>
<div class="line">                                                                    ;           Initialize before PRU FW load and run</div>
<div class="line">main:</div>
<div class="line">    ;Initializations</div>
<div class="line">    ldi     gpo_reg.b0, 0x00                                        ;Clear GPO and GPI registers</div>
<div class="line">    ldi     gpi_reg.b0, 0x00</div>
<div class="line">    ldi     zero_reg8, 0                                            ;Initialize constant value registers</div>
<div class="line">    ldi     offset_reg8, PRU_FW_VERSION_OFFSET</div>
<div class="line">    ldi     temp_reg32.w0, 0x0002                                   ;Write firmware version. Version 2</div>
<div class="line">    ldi     temp_reg32.w2, 0x0000</div>
<div class="line">    sbco    &amp;temp_reg32, c24, offset_reg8, 4</div>
<div class="line">    ldi     offset_reg8, FREEWHEELING_TIME_OFFSET                   ;Initialization of freewheeling time</div>
<div class="line">    lbco    &amp;freewheeling_countdown_reg32, c24, offset_reg8, 4</div>
<div class="line"> </div>
<div class="line">poll_gpi:</div>
<div class="line">    ;Wait for fault</div>
<div class="line">    mov     input_bits_reg8, gpi_reg.b0                             ;1 cycle. Latch input bits</div>
<div class="line">    qbeq    poll_gpi, input_bits_reg8, 0                            ;1 cycle. Poll inputs until non zero. Optimization: Remove this and directly look up. This will reduce latency to enter protection status, but reduces frequency of polling</div>
<div class="line">    lbco    &amp;trip_bits_reg8, c24, input_bits_reg8, 1                ;3 cycle. Look up in LUT at DMEM0. Optimization: move to PRU core registers</div>
<div class="line">    qbeq    poll_gpi, trip_bits_reg8, 0                             ;1 cycle. Continue to poll if no protection required</div>
<div class="line"> </div>
<div class="line">    ;Freewheeling</div>
<div class="line">    qbeq    end_freewheeling, freewheeling_countdown_reg32, 0       ;1 cycle. Skip freewheeling if no or 0 freewheeling time</div>
<div class="line">    ldi     gpo_reg.b0, 0x0a                                        ;1 cycle. Turn off all PWMs</div>
<div class="line">freewheeling:                                                       ; Freewheeling start.</div>
<div class="line">    sub     freewheeling_countdown_reg32, freewheeling_countdown_reg32, 1   ; 1 cycle * freewheeling time programmed</div>
<div class="line">    qbne    freewheeling, freewheeling_countdown_reg32, 0                   ; 1 cycle * freewheeling time programmed</div>
<div class="line">end_freewheeling:</div>
<div class="line"> </div>
<div class="line">    ;Apply protection and notify CPU</div>
<div class="line">    mov     gpo_reg.b0, trip_bits_reg8                              ;1 cycle. Apply trip output signals to GPO</div>
<div class="line">    sbco    &amp;trip_bits_reg8, c24, PROTECTION_STATUS_OFFSET, 1       ;2 cycle. Write trip bits as protection status</div>
<div class="line"> </div>
<div class="line">    ;Wait for clear command from CPU and clear</div>
<div class="line">poll_clr:</div>
<div class="line">    lbco    &amp;clr_reg8, c24, PROTECTION_STATUS_CLR_OFFSET, 1         ;3 cycles</div>
<div class="line">    qbeq    poll_clr, clr_reg8, 0                                   ;1 cycle. Poll for clear/ack request from R5F</div>
<div class="line">    ldi     gpo_reg.b0, 0x00                                        ;1 cycle. Clear trip output signals to GPO</div>
<div class="line">    sbco    &amp;zero_reg8, c24, PROTECTION_STATUS_OFFSET, 1            ;2 cycle. Clear protection status</div>
<div class="line">    sbco    &amp;zero_reg8, c24, PROTECTION_STATUS_CLR_OFFSET, 1        ;2 cycle. Clear clear/ack request</div>
<div class="line"> </div>
<div class="line">    ldi     offset_reg8, FREEWHEELING_TIME_OFFSET                   ;1 cycle. Re-Initialization of freewheeling time</div>
<div class="line">    lbco    &amp;freewheeling_countdown_reg32, c24, offset_reg8, 4      ;3 cycle.</div>
<div class="line"> </div>
<div class="line">    qba poll_gpi                                                    ;1 cycle</div>
</div><!-- fragment --><p>ICSS PRU firmware memory map:</p>
<ul>
<li>LUT_OFFSET<ul>
<li>16 byte Look up table for PRU FW use.</li>
<li>Input bits to trip output signal mapping</li>
</ul>
</li>
<li>PROTECTION_STATUS_OFFSET<ul>
<li>1 byte Protection status from PRU.</li>
<li>bit 0 PWM_A 100%,</li>
<li>bit 1 PWM_A 0%,</li>
<li>bit 2 PWM_B 100%,</li>
<li>bit 3 PWM_B 0%</li>
</ul>
</li>
<li>PROTECTION_STATUS_CLR_OFFSET<ul>
<li>1 byte Clear request from R5F.</li>
<li>0 - no clear request.</li>
<li>Non-zero - clear request</li>
</ul>
</li>
<li>PRU_FW_VERSION_OFFSET<ul>
<li>4 byte PRU firmware version</li>
</ul>
</li>
<li>FREEWHEELING_TIME_OFFSET<ul>
<li>4 byte Freewheeling time.</li>
<li>Absolute time in 10ns unit.</li>
</ul>
</li>
</ul>
<p>ICSS PRU Firmware latency:</p>
<p>Execution time - from detection of input fault signal to generation of trip output signal : 8 cycles * 5ns. 40ns</p>
<h1><a class="anchor" id="autotoc_md2340"></a>
External Connections</h1>
<h2><a class="anchor" id="autotoc_md2341"></a>
AM263X-CC or AM263PX-CC or AM261X-SOM</h2>
<p>Connect AM263x-CC or AM263Px-CC or AM261x-SOM to TMDSHSECDOCK (HSEC180 controlCARD Baseboard Docking Station)</p>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig4a.png"]{width:91%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig4a.png" alt=""/>
<div class="caption">
Figure 4a. External connections required</div></div>
<p>Connect IGBT, OCP, OVP and Speed Signals as below:</p><ul>
<li>Provide 'IGBT Fault signal' input to GPIO51<ul>
<li>3.3v -&gt; 1 (Low side IGBT has issue)</li>
<li>0v -&gt; 0 (no issue)</li>
</ul>
</li>
<li>Provide 'OCP Signal' input to GPIO52<ul>
<li>3.3v -&gt; 1 (Over current)</li>
<li>0v -&gt; 0 (current normal)</li>
</ul>
</li>
<li>Provide 'OVP Signal' input to GPIO53<ul>
<li>3.3v -&gt; 1 (Over voltage)</li>
<li>0v -&gt; 0 (voltage normal)</li>
</ul>
</li>
<li>(not supported) Provide 'Speed Signal' input to pin (TBD)<ul>
<li>PWM signal, PWM frequency corresponding to motor Speed. CPLD need to calculate the motor speed based on this PWM frequency and judge the speed &gt; Threshold or not.</li>
</ul>
</li>
<li>Provide 'Speed Level' input to GPIO54<ul>
<li>3.3v -&gt; 1 (Speed &gt; high Threshold)</li>
<li>0v -&gt; 0 (Speed &lt; high Threshold)</li>
</ul>
</li>
</ul>
<p>or connect IGBT, OCP, OVP and Speed Signals from HSEC as below:</p><ul>
<li>IGBT_FAULT_IN (GPIO51) Signal with IGBT_FAULT_OUT (GPIO55) Signal<ul>
<li>Connect HSEC Pin 57 to 58</li>
</ul>
</li>
<li>OCP_IN (GPIO52) Signal with OCP_OUT (GPIO56) Signal<ul>
<li>Connect HSEC Pin 59 to 60</li>
</ul>
</li>
<li>OVP_IN (GPIO53) Signal with OVP_OUT (GPIO57) Signal<ul>
<li>Connect HSEC Pin 61 to 62</li>
</ul>
</li>
<li>SPEED_LEVEL_IN (GPIO54) Signal with SPEED_LEVEL_OUT (GPIO58) Signal<ul>
<li>Connect HSEC Pin 63 to 64</li>
</ul>
</li>
<li>Capture EPWM0_A waveform at HSEC Pin 49</li>
<li>Capture EPWM0_B waveform at HSEC Pin 51</li>
<li>Capture EPWM1_A waveform at HSEC Pin 53</li>
<li>Capture EPWM1_B waveform at HSEC Pin 55</li>
<li>Capture EPWM2_A waveform at HSEC Pin 50</li>
<li>Capture EPWM2_B waveform at HSEC Pin 52</li>
</ul>
<h2><a class="anchor" id="autotoc_md2342"></a>
AM263X-LP or AM263PX-LP or AM261X-LP</h2>
<p>Connect IGBT, OCP, OVP and Speed Signals as below:</p><ul>
<li>Provide 'IGBT Fault signal' input to GPIO51<ul>
<li>3.3v -&gt; 1 (Low side IGBT has issue)</li>
<li>0v -&gt; 0 (no issue)</li>
</ul>
</li>
<li>Provide 'OCP Signal' input to GPIO52<ul>
<li>3.3v -&gt; 1 (Over current)</li>
<li>0v -&gt; 0 (current normal)</li>
</ul>
</li>
<li>Provide 'OVP Signal' input to GPIO53<ul>
<li>3.3v -&gt; 1 (Over voltage)</li>
<li>0v -&gt; 0 (voltage normal)</li>
</ul>
</li>
<li>(not supported) Provide 'Speed Signal' input to pin (TBD)<ul>
<li>PWM signal, PWM frequency corresponding to motor Speed. CPLD need to calculate the motor speed based on this PWM frequency and judge the speed &gt; Threshold or not.</li>
</ul>
</li>
<li>Provide 'Speed Level' input to GPIO54<ul>
<li>3.3v -&gt; 1 (Speed &gt; high Threshold)</li>
<li>0v -&gt; 0 (Speed &lt; high Threshold)</li>
</ul>
</li>
</ul>
<p>or connect IGBT, OCP, OVP and Speed Signals from HSEC as below:</p><ul>
<li>IGBT_FAULT_IN (GPIO51) Signal with IGBT_FAULT_OUT (GPIO55) Signal<ul>
<li>Connect J4 pin 36 to J8 pin 78</li>
</ul>
</li>
<li>OCP_IN (GPIO52) Signal with OCP_OUT (GPIO56) Signal<ul>
<li>Connect J4 pin 35 to J8 pin 77</li>
</ul>
</li>
<li>OVP_IN (GPIO53) Signal with OVP_OUT (GPIO57) Signal<ul>
<li>Connect J8 pin 80 to J8 pin 76</li>
</ul>
</li>
<li>SPEED_LEVEL_IN (GPIO54) Signal with SPEED_LEVEL_OUT (GPIO58) Signal<ul>
<li>Connect J8 pin 13 to J8 pin 75</li>
</ul>
</li>
<li>Capture EPWM3_A waveform at J4 pin 38</li>
<li>Capture EPWM3_B waveform at J4 pin 37</li>
<li>Capture EPWM1_A waveform at J7 pin 69</li>
<li>Capture EPWM1_B waveform at J7 pin 63</li>
<li>Capture EPWM2_A waveform at J4 pin 40</li>
<li>Capture EPWM2_B waveform at J4 pin 39</li>
</ul>
<h1><a class="anchor" id="EXAMPLES_DRIVERS_EPWM_PROTECTION_PRU_COMBOS"></a>
Supported Combinations</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter  </th><th class="markdownTableHeadNone">Value   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">CPU + OS  </td><td class="markdownTableBodyNone">r5fss0-0 nortos   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Toolchain  </td><td class="markdownTableBodyNone">ti-arm-clang   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Board  </td><td class="markdownTableBodyNone">am263x-cc   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Example folder  </td><td class="markdownTableBodyNone">examples/drivers/epwm/epwm_protection_pru   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md2343"></a>
Steps to Run the Example</h1>
<ul>
<li><b>When using CCS projects to build</b>, import the CCS project for the required combination and build it using the CCS project menu (see <a class="el" href="CCS_PROJECTS_PAGE.html">Using SDK with CCS Projects</a>).</li>
<li><b>When using makefiles to build</b>, note the required combination and build using make command (see <a class="el" href="MAKEFILE_BUILD_PAGE.html">Using SDK with Makefiles</a>)</li>
<li>Establish connections as mentioned in External Connections section</li>
<li>Launch a CCS debug session and run the executable, see <a class="el" href="CCS_LAUNCH_PAGE.html">CCS Launch, Load and Run</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md2344"></a>
See Also</h1>
<p><a class="el" href="DRIVERS_EPWM_PAGE.html">EPWM</a></p>
<h1><a class="anchor" id="autotoc_md2345"></a>
Sample Output</h1>
<p>Shown below is a sample output when the application is run,</p>
<div class="fragment"><div class="line">[Cortex_R5_0] EPWM Protection PRU Test Started ...</div>
<div class="line">PRU0 Processor disabled ...</div>
<div class="line">PRU0 IRAM written ...</div>
<div class="line">PRU LUT written ...</div>
<div class="line">Freewheeling time written ...</div>
<div class="line">PRU0 Processor enabled ...</div>
<div class="line">Normal PWM output (check PWM0_A, PWM0_B, PWM1_A, PWM1_B, PWM2_A, PWM2_B)...</div>
<div class="line">Generating test signals (IGBT fault, OCP, OVP, Speed level signals)...</div>
<div class="line">OCP set.</div>
<div class="line">Done...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Entered Protection status 0x0a...</div>
<div class="line">Clearing protection status...</div>
<div class="line">Waiting to clear protection status...</div>
<div class="line">Cleared protection status...</div>
<div class="line"> </div>
<div class="line">Normal PWM output (check PWM0_A, PWM0_B, PWM1_A, PWM1_B, PWM2_A, PWM2_B)...</div>
<div class="line">Generating test signals (IGBT fault, OCP, OVP, Speed level signals)...</div>
<div class="line">OCP set. IGBT fault set.</div>
<div class="line">Done...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Entered Protection status 0x0a...</div>
<div class="line">Clearing protection status...</div>
<div class="line">Waiting to clear protection status...</div>
<div class="line">Cleared protection status...</div>
<div class="line"> </div>
<div class="line">Normal PWM output (check PWM0_A, PWM0_B, PWM1_A, PWM1_B, PWM2_A, PWM2_B)...</div>
<div class="line">Generating test signals (IGBT fault, OCP, OVP, Speed level signals)...</div>
<div class="line">OVP set.</div>
<div class="line">Done...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Entered Protection status 0x0a...</div>
<div class="line">Clearing protection status...</div>
<div class="line">Waiting to clear protection status...</div>
<div class="line">Cleared protection status...</div>
<div class="line"> </div>
<div class="line">Normal PWM output (check PWM0_A, PWM0_B, PWM1_A, PWM1_B, PWM2_A, PWM2_B)...</div>
<div class="line">Generating test signals (IGBT fault, OCP, OVP, Speed level signals)...</div>
<div class="line">OVP set. IGBT fault set.</div>
<div class="line">Done...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Entered Protection status 0x0a...</div>
<div class="line">Clearing protection status...</div>
<div class="line">Waiting to clear protection status...</div>
<div class="line">Cleared protection status...</div>
<div class="line"> </div>
<div class="line">Normal PWM output (check PWM0_A, PWM0_B, PWM1_A, PWM1_B, PWM2_A, PWM2_B)...</div>
<div class="line">Generating test signals (IGBT fault, OCP, OVP, Speed level signals)...</div>
<div class="line">OCP set. OVP set.</div>
<div class="line">Done...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Entered Protection status 0x0a...</div>
<div class="line">Clearing protection status...</div>
<div class="line">Waiting to clear protection status...</div>
<div class="line">Cleared protection status...</div>
<div class="line"> </div>
<div class="line">Normal PWM output (check PWM0_A, PWM0_B, PWM1_A, PWM1_B, PWM2_A, PWM2_B)...</div>
<div class="line">Generating test signals (IGBT fault, OCP, OVP, Speed level signals)...</div>
<div class="line">OCP set. OVP set. IGBT fault set.</div>
<div class="line">Done...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Entered Protection status 0x0a...</div>
<div class="line">Clearing protection status...</div>
<div class="line">Waiting to clear protection status...</div>
<div class="line">Cleared protection status...</div>
<div class="line"> </div>
<div class="line">Normal PWM output (check PWM0_A, PWM0_B, PWM1_A, PWM1_B, PWM2_A, PWM2_B)...</div>
<div class="line">Generating test signals (IGBT fault, OCP, OVP, Speed level signals)...</div>
<div class="line">Speed level set. OCP set.</div>
<div class="line">Done...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Entered Protection status 0x0a...</div>
<div class="line">Clearing protection status...</div>
<div class="line">Waiting to clear protection status...</div>
<div class="line">Cleared protection status...</div>
<div class="line"> </div>
<div class="line">Normal PWM output (check PWM0_A, PWM0_B, PWM1_A, PWM1_B, PWM2_A, PWM2_B)...</div>
<div class="line">Generating test signals (IGBT fault, OCP, OVP, Speed level signals)...</div>
<div class="line">Speed level set. OCP set. IGBT fault set.</div>
<div class="line">Done...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Entered Protection status 0x0a...</div>
<div class="line">Clearing protection status...</div>
<div class="line">Waiting to clear protection status...</div>
<div class="line">Cleared protection status...</div>
<div class="line"> </div>
<div class="line">Normal PWM output (check PWM0_A, PWM0_B, PWM1_A, PWM1_B, PWM2_A, PWM2_B)...</div>
<div class="line">Generating test signals (IGBT fault, OCP, OVP, Speed level signals)...</div>
<div class="line">Speed level set. OVP set.</div>
<div class="line">Done...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Entered Protection status 0x06...</div>
<div class="line">Clearing protection status...</div>
<div class="line">Waiting to clear protection status...</div>
<div class="line">Cleared protection status...</div>
<div class="line"> </div>
<div class="line">Normal PWM output (check PWM0_A, PWM0_B, PWM1_A, PWM1_B, PWM2_A, PWM2_B)...</div>
<div class="line">Generating test signals (IGBT fault, OCP, OVP, Speed level signals)...</div>
<div class="line">Speed level set. IGBT fault set. OVP set.</div>
<div class="line">Done...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Entered Protection status 0x09...</div>
<div class="line">Clearing protection status...</div>
<div class="line">Waiting to clear protection status...</div>
<div class="line">Cleared protection status...</div>
<div class="line"> </div>
<div class="line">Normal PWM output (check PWM0_A, PWM0_B, PWM1_A, PWM1_B, PWM2_A, PWM2_B)...</div>
<div class="line">Generating test signals (IGBT fault, OCP, OVP, Speed level signals)...</div>
<div class="line">Speed level set. OVP set. OCP set.</div>
<div class="line">Done...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Entered Protection status 0x06...</div>
<div class="line">Clearing protection status...</div>
<div class="line">Waiting to clear protection status...</div>
<div class="line">Cleared protection status...</div>
<div class="line"> </div>
<div class="line">Normal PWM output (check PWM0_A, PWM0_B, PWM1_A, PWM1_B, PWM2_A, PWM2_B)...</div>
<div class="line">Generating test signals (IGBT fault, OCP, OVP, Speed level signals)...</div>
<div class="line">Speed level set. IGBT fault set. OVP set. OCP set.</div>
<div class="line">Done...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Waiting to enter protection status...</div>
<div class="line">Entered Protection status 0x09...</div>
<div class="line">Clearing protection status...</div>
<div class="line">Waiting to clear protection status...</div>
<div class="line">Cleared protection status...</div>
</div><!-- fragment --><p> <style>div.image img[src="am263_epwm_protection_pru_fig4h.png"]{width:100%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig4h.png" alt=""/>
<div class="caption">
Figure 4h. Waveform: Expected waveform from example</div></div>
<h2><a class="anchor" id="autotoc_md2346"></a>
Waveforms</h2>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig4b.png"]{width:100%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig4b.png" alt=""/>
<div class="caption">
Figure 4b. Waveform: Normal to Low ASC</div></div>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig4c.png"]{width:100%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig4c.png" alt=""/>
<div class="caption">
Figure 4c. Waveform: Normal to High ASC</div></div>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig4d.png"]{width:100%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig4d.png" alt=""/>
<div class="caption">
Figure 4d. Waveform: Normal to Shut down</div></div>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig4e.png"]{width:100%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig4e.png" alt=""/>
<div class="caption">
Figure 4e. Waveform: Deadband</div></div>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig4f.png"]{width:100%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig4f.png" alt=""/>
<div class="caption">
Figure 4f. Waveform: freewheeling</div></div>
<h2><a class="anchor" id="autotoc_md2347"></a>
Benchmarks</h2>
<p>OCP high to PWM shut down: Approx 105ns</p>
<p>This is the latency of following path: GPIO52 (receives OCP rising edge) -&gt; INPUTXBAR1 -&gt; PWMXBAR1 -&gt; GPI1 ICSS (PRU firmware reads GPI reg, process, writes to GPO reg) GPO0/1/2/3 (0101) -&gt; INPUTXBAR4/5/6/7 -&gt; PWMXBAR4/5/6/7 -&gt; EPWM0+1+2 Trip5/6/7/8 -&gt; PWM0/1/2 A/B(Falling edge)</p>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig4g.png"]{width:100%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig4g.png" alt=""/>
<div class="caption">
Figure 4g. Benchmark: time from trip signal to PWM output entering protection status</div></div>
<h1><a class="anchor" id="autotoc_md2348"></a>
References</h1>
<h2><a class="anchor" id="autotoc_md2349"></a>
ICSS connectivity</h2>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig5a.png"]{width:60%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig5a.png" alt=""/>
<div class="caption">
Figure 5a. ICSS connectivity</div></div>
<h2><a class="anchor" id="autotoc_md2350"></a>
AM263x XBARs</h2>
<p>InputXbar, PWMXbar</p>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig6a.png"]{width:60%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig6a.png" alt=""/>
<div class="caption">
Figure 6a. Input XBAR</div></div>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig6b.png"]{width:60%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig6b.png" alt=""/>
<div class="caption">
Figure 6b. PWM XBAR</div></div>
<h2><a class="anchor" id="autotoc_md2351"></a>
AM263x EPWM Digital Compare and Trip Zone module</h2>
<p> <style>div.image img[src="am263_epwm_protection_pru_fig6c.png"]{width:60%}</style> </p><div class="image">
<img src="am263_epwm_protection_pru_fig6c.png" alt=""/>
<div class="caption">
Figure 6c. EPWM Digital Compare and Trip Zone module</div></div>
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
