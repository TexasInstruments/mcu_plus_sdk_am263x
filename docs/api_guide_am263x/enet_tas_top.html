<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM263x MCU+ SDK: Enet EST/TAS Support</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM263x MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM263x MCU+ SDK
   &#160;<span id="projectnumber">11.00.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('enet_tas_top.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Enet EST/TAS Support </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#enet_est_intro">Introduction</a><ul><li class="level2"><a href="#enet_est_intro_est_tas">IEEE 802.1Qbv EST/TAS</a></li>
<li class="level2"><a href="#enet_est_intro_guard_band">Guard band</a></li>
</ul>
</li>
<li class="level1"><a href="#enet_est_api">Enet LLD API</a></li>
<li class="level1"><a href="#enet_est_cpsw">CPSW Support</a><ul><li class="level2"><a href="#enet_est_cpsw_driver">CPSW EST Driver Implementation</a></li>
<li class="level2"><a href="#enet_est_cpsw_guidelines">Programing Guidelines and Limitations</a><ul><li class="level3"><a href="#enet_est_cpsw_guidelines_admin_basetime">Administrative base time</a></li>
<li class="level3"><a href="#enet_est_cpsw_guidelines_gate_control_list">Gate control list</a></li>
<li class="level3"><a href="#enet_est_cpsw_guidelines_guard_band">Guard band</a></li>
<li class="level3"><a href="#enet_est_cpsw_guidelines_link_down">Link-down event</a></li>
<li class="level3"><a href="#enet_est_cpsw_limitations">Limitations</a></li>
</ul>
</li>
<li class="level2"><a href="#enet_est_cpsw_debugging">Debugging and Troubleshooting</a><ul><li class="level3"><a href="#enet_est_cpsw_timestamping">EST Timestamping</a></li>
<li class="level3"><a href="#enet_est_cpsw_gels">CCS Debug GEL Files</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_components_networking_enet_lld_enet_tas"></a></p>
<h1><a class="anchor" id="enet_est_intro"></a>
Introduction</h1>
<h2><a class="anchor" id="enet_est_intro_est_tas"></a>
IEEE 802.1Qbv EST/TAS</h2>
<p>IEEE 802.1Qbv <a href="https://en.wikipedia.org/wiki/Time-Sensitive_Networking#IEEE_802.1Qbv_Enhancements_to_Traffic_Scheduling:_Time-Aware_Shaper_(TAS)">Time-Aware Shaper</a> (TAS), which is also called <em>Enhancements for Scheduled Traffic</em> (EST) in IEEE Std 802.1Q-2018, defines a mechanism to allocate and grant exclusive Ethernet port transmission access on repeating cycles which are divided into slices where traffic of specific traffic class queues can be selected for transmission as per use-case requirements.</p>
<p>The diagram below shows a generic EST schedule composed of <em>n</em> slices (also called <em>time intervals</em>), each slice has specific <em>gate mask</em> that defines the state of each <em>transmission gate</em>: <em>open</em> or <em>closed</em>.</p>
<div class="image">
<img src="EST_Schedule_Diagram.png" alt=""/>
<div class="caption">
EST schedule</div></div>
<p><em>Transmission gates</em> are associated with specific traffic class queues (0-7). When a gate is <em>open</em>, frames from the corresponding queue can be selected for transmission. When the gate is <em>closed</em>, frames from the corresponding queue will not be selected for transmission. It's up to the application to determine the duration of each time slice and the state of each transmission gate.</p>
<p>The list of all gate states for all slices in the cycle is called <em>gate control list</em>. The control list that is programmed is called <em>administrative list</em>, when list becomes active is then called <em>operational list</em>.</p>
<p>For further information about TAS/EST specification, please refer to section <em>8.6.9 Scheduled traffic state machines</em> of IEEE 802.1Q-2018 standard document.</p>
<h2><a class="anchor" id="enet_est_intro_guard_band"></a>
Guard band</h2>
<p>It's worth noting that in EST, the transmission of a frame will not be interrupted, the full frame transmission will be completed even if it spills over the next time slice. This could pose a problem when traffic from the previous time slice, potentially of lower priority, spills over the next time slice meant for higher priority traffic.</p>
<p>A <a href="https://en.wikipedia.org/wiki/Time-Sensitive_Networking#IEEE_802.1Qbv_in_more_detail:_Time_slices_and_guard_bands">guard band</a>, which is a time slice with all gates closed, can be added right before critical time slices to ensure that wire is cleared of any previous traffic. The duration of the guard band must be set long enough for a packet of MTU size that initiated transmission right before the non-critical time slice ended had been fully transmitted.</p>
<p><a class="el" href="enet_tas_top.html">Back To Top</a></p>
<h1><a class="anchor" id="enet_est_api"></a>
Enet LLD API</h1>
<p>Enet LLD provides support for TAS/EST through the IOCTLs described in the <a class="el" href="group__ENET__MOD__TAS.html">Enet Time Aware Shaper</a> API Guide. The most important IOCTLs are listed below:</p>
<ul>
<li><a class="el" href="group__ENET__MOD__TAS.html#ggada0ad2c0a7a0c6530e49a3dd78c09ab2aa50cd9fdb7cb503427624610d7b3db61">ENET_TAS_IOCTL_SET_STATE</a>. Sets the state of TAS module for each MAC port:<ul>
<li><a class="el" href="group__ENET__MOD__TAS.html#gga3acb36109645d538c493fd97c7dc817ca292753a3b16c05651371772a1de565a1">ENET_TAS_RESET</a> to reset the state machine.</li>
<li><a class="el" href="group__ENET__MOD__TAS.html#gga3acb36109645d538c493fd97c7dc817ca22dfbd3f27824d920781a1e80e760e23">ENET_TAS_ENABLE</a> to start EST/TAS after a valid administrative list has been programmed.</li>
<li><a class="el" href="group__ENET__MOD__TAS.html#gga3acb36109645d538c493fd97c7dc817ca09b78dc8dc4d5f4129f855271ee9d8cf">ENET_TAS_DISABLE</a> to stop (idle) EST/TAS.</li>
</ul>
</li>
<li><a class="el" href="group__ENET__MOD__TAS.html#ggada0ad2c0a7a0c6530e49a3dd78c09ab2a2d555672c01e2a6720fd139936844561">ENET_TAS_IOCTL_SET_ADMIN_LIST</a>. Sets a new administrative list of type <a class="el" href="structEnetTas__ControlList.html">EnetTas_ControlList</a>. The gate control list is composed of:<ul>
<li><a class="el" href="structEnetTas__ControlList.html#a7f406efcb3b84f71ada4a61c9b3ea63f">baseTime</a>. The administrative base time which determines when the administrative list will become active.<ul>
<li>The base time can be set to a timestamp in the past, in which case the administrative list should become active right away.</li>
<li>The base time can also be set to a timestamp in the future, but note that not all Ethernet peripherals may fully support this feature.</li>
</ul>
</li>
<li><a class="el" href="structEnetTas__ControlList.html#ab6866461954473b6dbd7aa9db1f0a11e">gateCmdList</a>. The actual gate control list defined as list of <em>time interval duration</em> and <em>gate state mask</em> pairs. Enet LLD supports up to 16 intervals for simplicity, though some Ethernet peripherals may support larger number of intervals.</li>
<li><a class="el" href="structEnetTas__ControlList.html#afd4da3b610a5ee1f2cae3ab64673c471">listLength</a>. The number of entries in the gate control list.</li>
<li><a class="el" href="structEnetTas__ControlList.html#afffb7eefd4adf29b44118ed1680ad1c1">cycleTime</a>. The repeating cycle time.<ul>
<li>If it's larger that the accumulated time of all the intervals in the control list, the last time interval gets <em>extended</em> till end of the cycle.</li>
<li>If it's shorter than the accumulated interval time, then the gate control list gets <em>truncated</em> as per cycle time.</li>
</ul>
</li>
<li><a class="el" href="structEnetTas__ControlList.html#ab3c74ff9df91f1c1bb2df040cfb2be62">sduTable</a>. The maximum service data unit (SDU) per queue.</li>
</ul>
</li>
<li><a class="el" href="group__ENET__MOD__TAS.html#ggada0ad2c0a7a0c6530e49a3dd78c09ab2adf819fd64596c65886ac45fe7ce64fde">ENET_TAS_IOCTL_GET_OPER_LIST_STATUS</a>. Gets the status of the operational list update. It must be called after a new operational list has been set until driver acknowledges that the operational list has been updated by returning <a class="el" href="group__ENET__MOD__TAS.html#ggac07caadee47eaf55259b4afdf5b918aaa1c2a33d1c552b4cc747878fe6b0959a4">ENET_TAS_OPER_LIST_UPDATED</a>.</li>
<li><a class="el" href="group__ENET__MOD__TAS.html#ggada0ad2c0a7a0c6530e49a3dd78c09ab2adf819fd64596c65886ac45fe7ce64fde">ENET_TAS_IOCTL_GET_OPER_LIST_STATUS</a>. Gets the current operational list. It must be called after valid administrative list has been programmed. The operational list is a structure of type <a class="el" href="structEnetTas__ControlList.html">EnetTas_ControlList</a> which is the same type used for administrative lists describer earlier.</li>
</ul>
<p>The call sequence in the following diagram illustrates the typical usage of Enet LLD IOCTLs to configure EST/TAS on a given MAC port.</p>
<div class="image">
<img src="Enet_Est.png" alt=""/>
<div class="caption">
TAS IOCTL sequence in Enet LLD</div></div>
<p><a class="el" href="enet_tas_top.html">Back To Top</a></p>
<h1><a class="anchor" id="enet_est_cpsw"></a>
CPSW Support</h1>
<h2><a class="anchor" id="enet_est_cpsw_driver"></a>
CPSW EST Driver Implementation</h2>
<p>The EST functionality in CPSW is implemented in Enet LLD through two of its Enet LLD modules: CPTS and MAC port.</p>
<ul>
<li>Each Ethernet port has an <b>EST function generator (ESTF)</b> in the CPTS hardware module, this is used to program the EST <em>cycle time</em>.</li>
<li>Each Ethernet transmit port has 128 locations in the CPSW global <b>EST Fetch RAM</b> which is used to program the EST <em>gate control list</em>. The EST RAM is programmed with <em>fetch commands</em> which are composed of <em>fetch count</em> (time slice duration) and <em>fetch allow</em> (gate mask).</li>
</ul>
<p>The following diagram shows the EST schedule and the relevant CPSW components.</p>
<div class="image">
<img src="Cpsw_EST_Schedule_Diagram.png" alt=""/>
<div class="caption">
EST Schedule in CPSW</div></div>
<p><b>Fetch allow</b> is an 8-bit field, where each bit corresponds to the state of each of the 8 gates (one per priority) in a given time slice. The priority being referred to in the context of EST maps to the CPSW <em>switch priority</em> (not to be confused with other CPSW priority types: <em>packet priority</em> or <em>header packet priority</em>).</p>
<p><b>Fetch count</b> value is defined in terms of wireside clock cycles, so the link speed needs to be taken into account when computing the value to be set in hardware. This is taken care internally by the driver as the application can simply pass the time slice duration in nanoseconds.</p>
<p>The shortest time slice allowed by CPSW is a fetch count of 16, which corresponds to 128 nanoseconds for 1-Gbps link or 640 nanoseconds for 100-Mbps link. The longest time slice allowed by CPSW is determined by the length of the fetch count field (14-bits), which corresponds to 131.064 microseconds for 1-Gbps link or 655.32 microsecondds for 100-Mbps link.</p>
<p>The <b>EST Fetch RAM</b> can be configured in <em>one buffer</em> (all 128 locations operate as single buffer) or <em>two buffer operation</em> mode (two buffers of 64 locations each). Enet LLD configures the EST RAM in <b>two-buffer operation mode</b> in order to use one of the buffers to hold the <em>operational list</em>, while the other buffer can be programmed with the next <em>administrative list</em>. It's worth noting that only 16 of the 64 EST RAM locations are being currently used by the driver. This limitation comes from the size of the <a class="el" href="structEnetTas__ControlList.html#ab6866461954473b6dbd7aa9db1f0a11e">EnetTas_ControlList::gateCmdList</a> field in TAS IOCTL, which is <a class="el" href="group__ENET__MOD__TAS.html#ga5c58e8bfd260feeb2b2bd6073cec3ba1">ENET_TAS_MAX_CMD_LISTS</a>.</p>
<p>The <b>transmit queues size</b> is configurable in CPSW hardware via <code>CPSW_PN_MAX_BLKS</code> and <code>CPSW_PN_TX_BLKS_PRI</code> registers. <code>CPSW_PN_MAX_BLKS</code> can be used to set how many 1-kB blocks of a total of 20-kB are partitioned for TX and RX. <code>CPSW_PN_TX_BLKS_PRI</code> can be set used to specify how many of the 1-kB TX blocks can be occupied per priority. When all TX blocks allowed for a given priority are used, any new frame of that priority will be dropped.</p>
<p>Note that the transmit queue sizes are not configurable via Enet LLD at the moment. The default setting is 16 blocks for TX and 4 for RX. TX priority 7 can occupy all 16 blocks, priority 6 can occupy 15 blocks, ..., priority 0 can occupy only 8 blocks.</p>
<p>The following call sequence diagrams shows the steps taken by the driver when an administrative list is being programmed and EST is then being enabled.</p>
<div class="image">
<img src="CpswEst_Ioctls.png" alt=""/>
<div class="caption">
CPSW EST/TAS IOCTLs</div></div>
<p><a class="el" href="enet_tas_top.html">Back To Top</a></p>
<h2><a class="anchor" id="enet_est_cpsw_guidelines"></a>
Programing Guidelines and Limitations</h2>
<h3><a class="anchor" id="enet_est_cpsw_guidelines_admin_basetime"></a>
Administrative base time</h3>
<p>As per EST/TAS specification, the administrative base time can be set to a time ahead (future time) or behind current time (past time). When set to a past time, CPSW driver will start ESTF right away. When set to a future time, CPSW driver will handle it differently depending on the current EST state.</p>
<ul>
<li>If EST is in disabled (<a class="el" href="group__ENET__MOD__TAS.html#gga3acb36109645d538c493fd97c7dc817ca09b78dc8dc4d5f4129f855271ee9d8cf">ENET_TAS_DISABLE</a>) or reset (<a class="el" href="group__ENET__MOD__TAS.html#gga3acb36109645d538c493fd97c7dc817ca292753a3b16c05651371772a1de565a1">ENET_TAS_RESET</a>), states, then driver will allow a non-zero administrative base time, potentially a future time.</li>
<li>If EST is in enabled state (<a class="el" href="group__ENET__MOD__TAS.html#gga3acb36109645d538c493fd97c7dc817ca22dfbd3f27824d920781a1e80e760e23">ENET_TAS_ENABLE</a>), then driver will reject any non-zero administrative base time.</li>
</ul>
<p>Administrative base time at a future time is implemented in the driver using ESTF <em>timestamp comparison</em> feature, where driver can program the desired timestamp when ESTF will start generating its output. The EST schedule is programmed in EST RAM in advance, the active EST buffer is also set accordingly. This sequence is simpler to program when EST is not enabled, which is the main motivation for the special handling described in the previous points.</p>
<p><a class="el" href="enet_tas_top.html">Back To Top</a></p>
<h3><a class="anchor" id="enet_est_cpsw_guidelines_gate_control_list"></a>
Gate control list</h3>
<p>The gate control list passed to the CPSW EST driver can be one of the following types:</p>
<ul>
<li>Gate operation with non-zero time interval and non-zero gate mask. This is the <em>regular</em> gate operation for a time slice when at least one gate priority is enabled. User must set the time interval within the following limits:<ul>
<li><em>Minimum time interval</em> is 16 wireside clocks, so the equivalent time in nanoseconds depends on link speed. User can refer to the <a class="el" href="group__CPSW__MACPORT__MOD.html#ga2ef98baf8d908bc2481b71df41104d81">CPSW_MACPORT_EST_TIME_MIN</a> macro and pass the relevant link speed.</li>
<li><em>Maximum time interval</em> is determined by the length of the fetch count field (14-bits). User can refer to the <a class="el" href="group__CPSW__MACPORT__MOD.html#gafc8ca272ffe736067aac1f901b990710">CPSW_MACPORT_EST_TIME_MAX</a> macro and pass the relevant link speed.</li>
</ul>
</li>
</ul>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Link speed  </th><th class="markdownTableHeadCenter">Min time interval (nsecs)  </th><th class="markdownTableHeadCenter">Max time interval (nsecs)   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">1 Gbps  </td><td class="markdownTableBodyCenter">128  </td><td class="markdownTableBodyCenter">131,064   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">100 Mbps  </td><td class="markdownTableBodyCenter">640  </td><td class="markdownTableBodyCenter">655,320   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">10 Mbps  </td><td class="markdownTableBodyCenter">6,400  </td><td class="markdownTableBodyCenter">6,553,200   </td></tr>
</table>
<ul>
<li>Gate operation with non-zero time interval and zero gate mask. This is the gate operation used for guard band, intended to clear the wire for a packet in the next time interval. Guard band is described in more detail in next subsection.</li>
<li>Gate operation with zero time interval and non-zero gate mask. This gate operation will cause CPSW to hold the corresponding fetch allow for the remaining duration of the cycle.<ul>
<li>CPSW EST driver uses this gate operation type internally to handle <em>stretch</em> case (control list duration &lt; cycle time).</li>
<li>Application can use this operation type, but it must not be followed by a non-zero interval which is treated as error.</li>
</ul>
</li>
<li>Gate operation with zero time and zero gate mask. This is an invalid operation type.</li>
</ul>
<p><a class="el" href="enet_tas_top.html">Back To Top</a></p>
<h3><a class="anchor" id="enet_est_cpsw_guidelines_guard_band"></a>
Guard band</h3>
<p>When computing the duration of the guard band, the user must follow the <em>zero allow</em> guideline to compute the number of clocks needed to ensure wire is cleared from previous packet transmission:</p>
<ul>
<li>1-Gbps: <code>(maxPktLen + 4) + 292</code>.</li>
<li>10/100-Mbps: <code>((maxPktLen + 4) * 2) + 292</code>.</li>
</ul>
<p>where <code>maxPktLen</code> is the maximum packet length (excluding FCS) in the previous time interval.</p>
<p>For example, the guard band for 2020 bytes max frame size in the previous time slot in a 100-Mbps link, the <em>zero allow</em> should be: <code>((2020 + 4) * 2) + 292 = 4340</code>.</p>
<p>Just like any other time interval, the duration of the guard band passed to the driver has to be in nanoseconds but the zero allow values computed previuosly is in wireside clocks, so it must be converted to nanoseconds:</p>
<ul>
<li>1-Gbps: <code>((maxPktLen + 4) + 292) * 8</code>.</li>
<li>100-Mbps: <code>(((maxPktLen + 4) * 2) + 292) * 40</code>.</li>
<li>10-Mbps: <code>(((maxPktLen + 4) * 2) + 292) * 400</code>.</li>
</ul>
<p>A helper macro (<a class="el" href="group__CPSW__MACPORT__MOD.html#gaae5e9fdf93fa3f0ad3228cbeb496e83d">CPSW_MACPORT_EST_GUARD_BAND</a>) is provided to compute the guard band duration. User must pass the link speed (<code>1G</code>, <code>100M</code> or <code>10M</code>) and the maximum packet length in the previuos time interval (excluding FCS).</p>
<p>For more details about the <em>zero allow</em> duration guideline, please refer to the TRM section called <em>EST fetch values</em>, in the CPSW chapter.</p>
<p><a class="el" href="enet_tas_top.html">Back To Top</a></p>
<h3><a class="anchor" id="enet_est_cpsw_guidelines_link_down"></a>
Link-down event</h3>
<p>As described in <a class="el" href="enet_tas_top.html#enet_est_cpsw_driver">CPSW EST Driver Implementation</a> section, the <em>fetch allow</em> value programmed into EST RAM is in wireside clocks, so the link speed needs to be taken into account when computing the allow value from a desired time interval duration in microseconds.</p>
<p>When link is lost, the previous link speed is no longer valid or relevant, hence CPSW driver will clear the previous operational list programmed in EST RAM as part of its link lost event handling.</p>
<p>This also implies that application has to program again an administrative control list via <a class="el" href="group__ENET__MOD__TAS.html#ggada0ad2c0a7a0c6530e49a3dd78c09ab2a2d555672c01e2a6720fd139936844561">ENET_TAS_IOCTL_SET_ADMIN_LIST</a> command when link is back up. Enet LLD will not automatically restore the previous control list.</p>
<p><a class="el" href="enet_tas_top.html">Back To Top</a></p>
<h3><a class="anchor" id="enet_est_cpsw_limitations"></a>
Limitations</h3>
<p>The following EST features are not supported by the driver:</p><ul>
<li>Administrative cycle time different from current operational cycle time is not supported.</li>
<li>Administrative cycle time extension is not supported.</li>
<li>Configuration of Maximum SDU table is not supported.</li>
<li>Administrative list needs to be configured again by application after link down events.</li>
</ul>
<p>The following EST features have limited support in the driver:</p><ul>
<li>Administrative base time at a future time is only supported when EST is not enabled.</li>
<li>Time slices longer than 131.064 microseconds (1-Gpbs) or 655.32 microseconds (100-Mbps) will be rejected by the driver. It's up to the application to add two or more consecutive slots with same gate mask to accommodate for longer time slices.</li>
</ul>
<p><a class="el" href="enet_tas_top.html">Back To Top</a></p>
<h2><a class="anchor" id="enet_est_cpsw_debugging"></a>
Debugging and Troubleshooting</h2>
<h3><a class="anchor" id="enet_est_cpsw_timestamping"></a>
EST Timestamping</h3>
<p>EST packet timestamping can be used as an aid for debugging purposes to verify if packets are being transmitted at the expect time based on the programmed EST schedule. CPSW supports four types of <b>timestamping modes</b>:</p>
<ul>
<li><a class="el" href="structTimestamp.html" title="The Timestamp type represents a positive time with respect to the epoch.">Timestamp</a> all packets on any priority.</li>
<li><a class="el" href="structTimestamp.html" title="The Timestamp type represents a positive time with respect to the epoch.">Timestamp</a> all packets of given priority.</li>
<li><a class="el" href="structTimestamp.html" title="The Timestamp type represents a positive time with respect to the epoch.">Timestamp</a> the first packet in each time interval (time slice).</li>
<li><a class="el" href="structTimestamp.html" title="The Timestamp type represents a positive time with respect to the epoch.">Timestamp</a> the first packet of a given priority in the time interval.</li>
</ul>
<p>CPSW driver provides the following private <b>EST timestamp related IOCTLs</b> to <em>enable</em>, <em>disable</em> and <em>retrieve</em> the generated EST timestamp events:</p>
<ul>
<li><a class="el" href="group__CPSW__MACPORT__MOD.html#gga9f78d0e84102d48a7c5097bd27620d6fab182235fcc76e2ab7328ff1de0ca10a6">CPSW_MACPORT_IOCTL_EST_ENABLE_TIMESTAMP</a>. Enables EST packet timestamping according to the requested configuration (<a class="el" href="structCpswMacPort__EstTimestampCfg.html">CpswMacPort_EstTimestampCfg</a>):<ul>
<li><a class="el" href="structCpswMacPort__EstTimestampCfg.html#a9326e5f75b12c942feb7f1771443a1bb">mode</a>. One of the four <a class="el" href="group__CPSW__MACPORT__MOD.html#ga9975e049d2db0ff20240055f9673566b">timestamping modes</a> described earlier.</li>
<li><a class="el" href="structCpswMacPort__EstTimestampCfg.html#af0e0719ce83b5cf0fa4af08ee6aad3f5">priority</a>. Only packets with this priority will be timestamped. Applicable to <a class="el" href="group__CPSW__MACPORT__MOD.html#gga9975e049d2db0ff20240055f9673566ba378d2ea8fc14f9daee8332d411df6952">CPSW_MACPORT_EST_TIMESTAMP_ONEPRI</a> and <a class="el" href="group__CPSW__MACPORT__MOD.html#gga9975e049d2db0ff20240055f9673566baf3a4e41242b4dcb595ac99b1c7fc677e">CPSW_MACPORT_EST_TIMESTAMP_FIRST_ONEPRI</a> modes only.</li>
<li><a class="el" href="structCpswMacPort__EstTimestampCfg.html#a9dfefe4cb28d1d6a17d47c99d1236595">domain</a>. EST timestamped events will have this domain id when retrieved from CPTS.</li>
</ul>
</li>
<li><a class="el" href="group__CPSW__MACPORT__MOD.html#gga9f78d0e84102d48a7c5097bd27620d6faa68211d9809d6aa5fca41f07e3c3f97b">CPSW_MACPORT_IOCTL_EST_DISABLE_TIMESTAMP</a>. Disables EST packet timestamping.</li>
<li><a class="el" href="group__CPSW__CPTS__MOD.html#ggab788726fe114cfc32a32011edfa724ffac0a8dd0957cbe423b3b64dfea807c34d">CPSW_CPTS_IOCTL_LOOKUP_EST_EVENT</a>. Retrieves EST timestamps from CPTS driver using a match criteria (<a class="el" href="structCpswCpts__EstEventMatchParams.html" title="CPTS EST event match params.">CpswCpts_EstEventMatchParams</a>) of MAC port number and domain. The domain should be the same one used during enable phase in <a class="el" href="group__CPSW__MACPORT__MOD.html#gga9f78d0e84102d48a7c5097bd27620d6fab182235fcc76e2ab7328ff1de0ca10a6">CPSW_MACPORT_IOCTL_EST_ENABLE_TIMESTAMP</a>.</li>
</ul>
<p>Apart from the actual timestamp value in nanoseconds, the <b>EST timestamp events</b> (<a class="el" href="structCpswCpts__EstEvent.html">CpswCpts_EstEvent</a>) also carry information about the priority (CPSW <em>switch priority</em>), sequence number, ingress port (host port or another MAC port where packet was initially received), egress port (the MAC port where EST packet was transmitted) and the domain number.</p>
<p>Just like with any other CPTS event, CPSW driver services the CPTS interrupt that is generated for each EST timestamp event, pops the event from the CPTS FIFO and copies the event information into a software pool. The timestamp event will reside in this software pool until the application reads it through <a class="el" href="group__CPSW__CPTS__MOD.html#ggab788726fe114cfc32a32011edfa724ffac0a8dd0957cbe423b3b64dfea807c34d">CPSW_CPTS_IOCTL_LOOKUP_EST_EVENT</a> command. This process will consume additional CPU cycles so it's advised that this feature is not kept permanently enabled.</p>
<p>The CPTS software pools (<a class="el" href="enet__cfg_8h.html#a2ea7255e96326c8c6a4eccded84a9cd1">ENET_CFG_CPSW_CPTS_EVENTS_POOL_SIZE</a>) need to be sized properly to accommodate for bursty traffic. Driver will overwrite oldest events in the pool as it handles new timestamp events.</p>
<p><a class="el" href="enet_tas_top.html">Back To Top</a></p>
<h3><a class="anchor" id="enet_est_cpsw_gels"></a>
CCS Debug GEL Files</h3>
<p>CPSW debug GEL files can be loaded by loading the startup GEL file which can be located at <code>&lt;mcu_plus_sdk&gt;/source/networking/enet/core/tools/debug_gels/cpsw_startup.gel</code>.</p>
<p>The following image shows the EST GEL files once they have been loaded into CCS.</p>
<div class="image">
<img src="Cpsw_Est_Gels.png" alt=""/>
<div class="caption">
CPSW EST debug GEL files</div></div>
<p>The available GEL functions are:</p>
<ul>
<li><code>cpsw_est_show_global_config</code>. Shows the global EST enable configuration as well as few other relevant fields of <code>CPSW_CONTROL</code> register.</li>
<li><code>cpsw_est_show_config</code>. Shows the per MAC port relevant configuration:<ul>
<li>EST enable.</li>
<li>EST control: buffer mode (one or two buffer), selected buffer, timestamp configuration.</li>
<li>EST status: active buffer.</li>
<li>MAC control: gigabit enable, full-duplex configuration.</li>
</ul>
</li>
<li><code>cpsw_est_dump_ram</code>. Dumps the non-zero EST RAM locations. Due to two-buffer mode used by the driver, expectation is to see non-zero locations at:<ul>
<li>Indexes 0, 1, 2, ..., when buffer 1 is active.</li>
<li>Indexes 63, 64, 65, ..., when buffer 2 is active.</li>
</ul>
</li>
<li><code>cpsw_cpts_show_global_config</code>. Shows relevant CPTS global configuration which affects all ESTF instandes.<ul>
<li>Global CPTS configuration in <code>CPTS_CONTROL</code> register, such as CPTS enable, mode (32 or 64-bit), among others.</li>
<li>CPTS timestamp add value in <code>CPTS_TS_ADD_VAL</code> register. Useful to infer the CPTS reference clock frequency: <code>TS_ADD_VAL + 1</code> is the timestamp increment value per CPTS clock pulse.</li>
</ul>
</li>
<li><code>cpsw_cpts_estf_show_config</code>. Shows the per MAC port ESTF configuration:<ul>
<li>Admin base time is configured in <code>ESTF_COMP_HIGH</code> (32 msbits) and <code>ESTF_COMP_LOW</code> (32 lsbits) fields.</li>
<li>Cycle time is configured in <code>ESTF_LENGTH</code> field: <code>ESTF_LENGTH * (TS_ADD_VAL + 1)</code> is the cycle duration in nanoseconds.</li>
</ul>
</li>
<li><code>cpsw_est_show_all_config</code>. Helper function that will run all previous GEL functions for a given MAC port.</li>
</ul>
<p>Note that a pop-up window will appear when running GEL functions that are MAC port dependent (i.e. EST RAM, ESTF). Enter the value corresponding to the MAC port of interest.</p>
<p><a class="el" href="enet_tas_top.html">Back To Top</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
