<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM263x MCU+ SDK: Enet Layer 2 Multi-Channel Example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM263x MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM263x MCU+ SDK
   &#160;<span id="projectnumber">11.00.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('EXAMPLES_ENET_LAYER2_MULTI_CHANNEL.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Enet Layer 2 Multi-Channel Example </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md2985">Introduction</a></li>
<li class="level1"><a href="#autotoc_md2986">Configuration Parameters</a><ul><li class="level2"><a href="#autotoc_md2987">Configuring the Packeth tool to send vlan tagged packets</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md2988">Application Functionality</a></li>
<li class="level1"><a href="#autotoc_md2989">Application Flow</a></li>
<li class="level1"><a href="#autotoc_md2990">Channel Overriding</a></li>
<li class="level1"><a href="#autotoc_md2991">Supported Combinations</a></li>
<li class="level1"><a href="#autotoc_md2992">Packet pool configuration</a></li>
<li class="level1"><a href="#autotoc_md2993">Steps to Run the Example</a><ul><li class="level2"><a href="#autotoc_md2994">Build the example</a></li>
<li class="level2"><a href="#autotoc_md2995">HW Setup</a></li>
<li class="level2"><a href="#autotoc_md2996">Run the example</a></li>
<li class="level2"><a href="#autotoc_md2997">Sample output for Multi-Channel example</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md2998">See Also</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_examples_networking_enet_layer2_multi_channel"></a></p>
<h1><a class="anchor" id="autotoc_md2985"></a>
Introduction</h1>
<p>The Multi-channel example illustrates the usage of multiple channels of CPDMA. The application creates two independent TX and RX channels each, one for L2 echo server and the second for TimeSync PTP stack.</p>
<p>This example illustrates the usage of multiple CPDMA channels to carry two types of traffic: echo test and PTP. The segregation of Ethernet packets into separate CPDMA channel is based on the priority field (PCP) of the 802.1Q VLAN tagged packets. PTP packets are expected to have a priority of 1, and echo test packets a priority of 0. The source generator for packets must send packets with 802.1Q VLAN tag enabled to the application.</p>
<p> <style>div.image img[src="802.1Q_vlan_tag_format.png"]{width:25%}</style> </p><div class="image">
<img src="802.1Q_vlan_tag_format.png" alt=""/>
<div class="caption">
802.1Q VLAN Tag Format</div></div>
<p> <style>div.image img[src="cpdma_channels_control_flow.png"]{width:40%}</style> </p><div class="image">
<img src="cpdma_channels_control_flow.png" alt=""/>
<div class="caption">
CPDMA Channels Control Flow</div></div>
<ul>
<li>Enet-lld utilizes hardware timestamping provided by CPTS(CPSW) and provides IOCTL commands for enabling Packet Timestamping functionality.</li>
<li>The Multi-channel example illustrates using three such IOCTL Commands to exercise the CPTS IOCTLs from application(<a class="el" href="group__ENET__MOD__TIMESYNC.html#ggaaf38d27f2346094db6344f81685a3a7dae1df89e88b8218322d89b3623486944e">ENET_TIMESYNC_IOCTL_GET_CURRENT_TIMESTAMP</a>, <a class="el" href="group__ENET__MOD__TIMESYNC.html#ggaaf38d27f2346094db6344f81685a3a7da026b1d4ec4b6a5fb1c11b8fd24ac9fa1">ENET_TIMESYNC_IOCTL_GET_ETH_RX_TIMESTAMP</a>, <a class="el" href="group__ENET__MOD__TIMESYNC.html#ggaaf38d27f2346094db6344f81685a3a7da224b4b0b9042d42ab524d61615c9db02">ENET_TIMESYNC_IOCTL_GET_ETH_TX_TIMESTAMP</a>). Appropriate apis are defined for calling these IOCTLs and enet-lld has implementation for the IOCTLs to execute the desired feature.</li>
<li>This example also illustrates on registering for CPTS event notification by using IOCTL ref\ CPSW_CPTS_IOCTL_REGISTER_STACK .</li>
<li>Moreover, the example also has a demo of 'PTP Ordinary Clock' using a combined Timesync PTP stack using P2P delay mechanism.</li>
<li>Please refer <a class="el" href="group__ENET__MOD__TIMESYNC.html">Enet Time Synchronization</a> for details on all other IOCTLs supported by ENET-LLD for Timesync.</li>
</ul>
<p>On AM263X, we can do ethernet based communication using CPSW HW mechanism</p>
<ul>
<li>CPSW is a standard ethernet switch + port HW</li>
<li>It uses ethernet driver underneath with LwIP TCP/IP networking stack</li>
</ul>
<h1><a class="anchor" id="autotoc_md2986"></a>
Configuration Parameters</h1>
<ol type="1">
<li>Opening TX 0 and TX 1 channels using EnetAppUtils_openTxCh () API by passing channel number as a parameter to this API.</li>
<li>Opening RX channels 0 and 1 using EnetAppUtils_openRxCh () API by passing channel number as a parameter to this API.</li>
<li>Separate RX task and RX packet callback needs to be implemented for each channel creation. Existing flows for channels can be referred to.</li>
<li>Set the vlanLType1 field of macport stats in EnetApp_setPortTsEventPrms () API to 0x8100, to make CPTS aware of VLAN tagging enabled for packets.</li>
<li>CPDMA supports upto 8 TX/RX channels. By default, applications has only 3 TX/RX channels and this can be changed by modifying the macros ENET_CFG_CPDMA_CPSW_MAX_TX_CH/ENET_CFG_CPDMA_CPSW_MAX_RX_CH in <a class="el" href="enet__cfg_8h.html" title="This file contains the Enet configuration parameters.">enet_cfg.h</a> file.</li>
</ol>
<h2><a class="anchor" id="autotoc_md2987"></a>
Configuring the Packeth tool to send vlan tagged packets</h2>
<p>In packETH tool, select the 802.1q field to configure vlan parameters(priority).</p>
<p> <style>div.image img[src="packeth_setup.png"]{width:40%}</style> </p><div class="image">
<img src="packeth_setup.png" alt=""/>
<div class="caption">
Packeth tool configuration for 802.1q vlan tag</div></div>
<h1><a class="anchor" id="autotoc_md2988"></a>
Application Functionality</h1>
<p> <style>div.image img[src="multi_channel_app_functionality.png"]{width:40%}</style> </p><div class="image">
<img src="multi_channel_app_functionality.png" alt=""/>
<div class="caption">
Application Functionality</div></div>
<p>Packeth tool is configured with the 802.1Q (PCP) field set to either 0 or 1 to send either L2 packets or PTP packets. CPSW peripheral maps the value of the PCP field to appropriate DMA channel queue for the receiving packets.</p>
<h1><a class="anchor" id="autotoc_md2989"></a>
Application Flow</h1>
<p> <style>div.image img[src="multi_channel_app_flow.png"]{width:40%}</style> </p><div class="image">
<img src="multi_channel_app_flow.png" alt=""/>
<div class="caption">
Application Flow</div></div>
<p>The Multi-channel app on starting its main task initializes the Enet driver, memory and queues. Followed by this, the app opens the CPSW peripheral and creates two pairs of TX and RX channels:</p><ol type="1">
<li>L2 echo server</li>
<li>PTP Timestamping</li>
</ol>
<p>Each RX channel will have a separate OS task to process each traffic type separately. Additionally, the test enables timestamping of PTP packets. The Multi-channel App continues to run until user decides to terminate the app by pressing ‘x’ from the App menu.</p>
<h1><a class="anchor" id="autotoc_md2990"></a>
Channel Overriding</h1>
<p>To override the channel mapping, we can use ALE classifier along with CPDMA_CONTROL.</p><ul>
<li>The example shows the usage of ALE classifier where we create a classifier based on Ethertype and route the matched traffic to the corresponding RX channel.</li>
<li>CPDMA provides channel override feature using the thost_ch_override bit in CPDMA_CONTROL register.</li>
<li>When set, the RX channel is overridden with the ALE classification match value. This value is what we set in the ALE Classifier as threadId.</li>
<li>We need to set the default channel when we are overriding, this will handle the unclassified traffic and is passed as a parameter to EnetApp_setCpswAleClassifier() API. The application sets RX channel 0 to be the default channel for handling unclassified traffic.</li>
<li>We need to set the enChOverrideFlag Flag in the application if we want to use the channel overriding feature. This is done in EnetApp_open() API.</li>
</ul>
<h1><a class="anchor" id="autotoc_md2991"></a>
Supported Combinations</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter  </th><th class="markdownTableHeadNone">Value   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">CPU + OS  </td><td class="markdownTableBodyNone">r5fss0-0_freertos r5fss0-1_freertos   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Toolchain  </td><td class="markdownTableBodyNone">ti-arm-clang   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Boards  </td><td class="markdownTableBodyNone">am263x-cc   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Example folder  </td><td class="markdownTableBodyNone">source/networking/enet/core/examples/enet_layer2_multi_channel/V1   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md2992"></a>
Packet pool configuration</h1>
<p>To change packet pool configuration from syscfg, please refer to <a class="el" href="PACKETPOOL_CONFIG_TOP.html">Ethernet Packet Pool Allocation Guidelines</a></p>
<h1><a class="anchor" id="autotoc_md2993"></a>
Steps to Run the Example</h1>
<h2><a class="anchor" id="autotoc_md2994"></a>
Build the example</h2>
<ul>
<li>When using CCS projects to build, import the CCS project for the required combination and build it using the CCS project menu (see <a class="el" href="CCS_PROJECTS_PAGE.html">Using SDK with CCS Projects</a>).</li>
<li>When using makefiles to build, note the required combination and build using make command (see <a class="el" href="MAKEFILE_BUILD_PAGE.html">Using SDK with Makefiles</a>)</li>
</ul>
<h2><a class="anchor" id="autotoc_md2995"></a>
HW Setup</h2>
<dl class="section note"><dt>Note</dt><dd>Make sure you have setup the EVM with cable connections as shown here, <a class="el" href="EVM_SETUP_PAGE.html">EVM Setup</a>. In addition do below steps.</dd></dl>
<h2><a class="anchor" id="autotoc_md2996"></a>
Run the example</h2>
<dl class="section attention"><dt>Attention</dt><dd>If you need to reload and run again, a CPU power-cycle is MUST</dd></dl>
<ul>
<li>Launch a CCS debug session and run the example executable, see <a class="el" href="CCS_LAUNCH_PAGE.html">CCS Launch, Load and Run</a></li>
<li>You will see logs in the UART terminal as shown in the next section.</li>
<li>We can start sending packets with Multicast addresses (01:80:C2:00:00:0E) PTP frames (Ethertype 0x88F7U) from Colasoft Pkt Builder or packETH tool and capture the packets in Wireshark. Packets must be sent with 802.1Q VLAN tag enabled to the application.</li>
<li>By selecting 't' option from the menu we can toggle the timestamp printing on the Terminal.</li>
</ul>
<h2><a class="anchor" id="autotoc_md2997"></a>
Sample output for Multi-Channel example</h2>
<div class="fragment"><div class="line">==========================</div>
<div class="line">   L2 Multi-channel Test</div>
<div class="line">==========================</div>
<div class="line"> </div>
<div class="line">Init all peripheral clocks</div>
<div class="line">----------------------------------------------</div>
<div class="line"> </div>
<div class="line">Create RX tasks</div>
<div class="line">----------------------------------------------</div>
<div class="line">cpsw-3g: Create RX task</div>
<div class="line"> </div>
<div class="line">Open all peripherals</div>
<div class="line">----------------------------------------------</div>
<div class="line">cpsw-3g: Open enet</div>
<div class="line"> </div>
<div class="line">Init all configs</div>
<div class="line">----------------------------------------------</div>
<div class="line">cpsw-3g: init config</div>
<div class="line">Link Status Changed. PHY: 0x0, state: up</div>
<div class="line">Open MAC port 1</div>
<div class="line">EnetPhy_bindDriver:1873 </div>
<div class="line">PHY 0 is alive</div>
<div class="line">PHY 3 is alive</div>
<div class="line"> </div>
<div class="line">Attach core id 0 on all peripherals</div>
<div class="line">----------------------------------------------</div>
<div class="line">cpsw-3g: Attach core</div>
<div class="line">cpsw-3g: Open DMA</div>
<div class="line">initQs() freePktInfoQ initialized with 16 pkts</div>
<div class="line">initQs() freePktInfoQ initialized with 16 pkts</div>
<div class="line">cpsw-3g: Waiting for link up...</div>
<div class="line">Cpsw_handleLinkUp:1653 </div>
<div class="line">MAC Port 1: link up</div>
<div class="line">cpsw-3g: Port 1 link is up</div>
<div class="line">cpsw-3g: MAC port addr: f4:84:4c:fc:34:fe</div>
<div class="line">TimeSync PTP enabled</div>
<div class="line"> </div>
<div class="line">Enet Multi-channel Menu:</div>
<div class="line"> &#39;c&#39;  -  GetCurrentTime</div>
<div class="line"> &#39;t&#39;  -  Toggle Printing timestamps</div>
<div class="line"> &#39;s&#39;  -  Print statistics</div>
<div class="line"> &#39;r&#39;  -  Reset statistics</div>
<div class="line"> &#39;m&#39;  -  Show allocated MAC addresses</div>
<div class="line"> &#39;p&#39;  -  Enable Policer for rate limiting</div>
<div class="line"> &#39;x&#39;  -  Stop the test</div>
<div class="line"> </div>
<div class="line">t</div>
<div class="line"> </div>
<div class="line">Enable Timestamp Printing </div>
<div class="line">TX Timestamp: 12042935861</div>
<div class="line">TX Timestamp: 12252934996</div>
<div class="line">TX Timestamp: 12462935116</div>
<div class="line">TX Timestamp: 20672934936</div>
<div class="line">TX Timestamp: 20882934951</div>
<div class="line">TX Timestamp: 21092935541</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md2998"></a>
See Also</h1>
<p><a class="el" href="NETWORKING.html">Ethernet And Networking</a> |</p>
<p><a class="el" href="EXAMPLES_ENET_CPSW_TSN_GPTP_BRIDGE.html">Ethernet TSN CPSW gPTP Bridge Example</a> | <a class="el" href="EXAMPLES_ENET_CPSW_TSN_GPTP_TR.html">Ethernet TSN CPSW gPTP TimeReceiver (gPTP Slave) Example</a> | <a class="el" href="EXAMPLES_ENET_CPSW_TSN_GPTP_TT.html">Ethernet TSN CPSW gPTP TimeTransmitter (gPTP Master) Example</a> | <a class="el" href="ENET_CPSW_TSN_GPTP.html">Ethernet TSN and gPTP Stack - API and Integration Guide</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
