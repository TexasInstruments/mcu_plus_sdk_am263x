<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM263x MCU+ SDK: Optimizing Real Time Control Applications</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM263x MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM263x MCU+ SDK
   &#160;<span id="projectnumber">11.00.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('OPTIMIZING_REAL_TIME_CONTROL_APPLICATIONS.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Optimizing Real Time Control Applications </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#CHAPTER_ABOUT">About this document</a></li>
<li class="level1"><a href="#CHAPTER_OPERATION">Real Time Control Loop</a><ul><li class="level2"><a href="#CHAPTER_OPERATION_SECTION_0">Control Interrupts and ISR</a></li>
<li class="level2"><a href="#CHAPTER_OPERATION_SECTION_1">Operation 1: Latch and respond to interrupt</a></li>
<li class="level2"><a href="#CHAPTER_OPERATION_SECTION_2">Operation 2: R5F Context save</a></li>
<li class="level2"><a href="#CHAPTER_OPERATION_SECTION_3">Operation 3: R5F read accesses to sensed inputs</a></li>
<li class="level2"><a href="#CHAPTER_OPERATION_SECTION_4">Operation 4: R5F executes calcuations/algorithm</a></li>
<li class="level2"><a href="#CHAPTER_OPERATION_SECTION_5">Operation 5: R5F writes to outputs</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_developer_guides_optimizing_real_time_control_applications"></a></p>
<h1><a class="anchor" id="CHAPTER_ABOUT"></a>
About this document</h1>
<p>This guide describes the performance optimizations of real-time applications on the Texas Instruments AM263X platform.</p>
<p>TI’s Sitara MCU processor AM263X is designed for real-time control applications, specifically for use cases such as Traction inverters, Onboard chargers, Charging stations, DC-DC converters, Industrial AC inverters, String inverters and Industrial communication. Crucial aspect of such applications is the signal chain performance. Latency of the signal chain determines the efficiency and performance of the system.</p>
<p>The goal of this document is to provide a comprehensive guide to performance optimization on the AM263X platform and help real-time application developers achieve their performance goals.</p>
<ol type="1">
<li>Signal chain performance considerations. See <a class="el" href="OPTIMIZING_REAL_TIME_CONTROL_APPLICATIONS.html#CHAPTER_OPERATION">Real Time Control Loop</a></li>
<li>List of <a class="el" href="OPTIMIZING_APPLICATIONS_WITH_MCU_SDK.html#CHAPTER_OPTIMIZATION">Optimizations</a><ul>
<li>Software, SoC hardware and application</li>
<li>Best practices, recommendations and step-by-step guide</li>
</ul>
</li>
</ol>
<h1><a class="anchor" id="CHAPTER_OPERATION"></a>
Real Time Control Loop</h1>
<ul>
<li>Crucial aspect of Real Time Control applications is signal chain performance – which includes sensing, processing and actuation. Latency of the signal chain determines the efficiency and performance of the system (for example: RPM of traction motor in automotive EV application).<ul>
<li>Sensing uses on-chip analog to digital converters, comparators,..</li>
<li>Actuation uses PWM generation modules</li>
<li>Processing involves the CPU core (R5F in AM263X) running control loop algorithm</li>
</ul>
</li>
</ul>
<p> <style>div.image img[src="Fig1.PNG"]{width:80%}</style> </p><div class="image">
<img src="Fig1.PNG" alt=""/>
<div class="caption">
Signal chain</div></div>
<h2><a class="anchor" id="CHAPTER_OPERATION_SECTION_0"></a>
Control Interrupts and ISR</h2>
<p>Interrupt Service Routines, commonly referred to as ISRs, play a critical role in real-time control applications. Control ISRs are often used in real-time control systems to read sensed (typically ADC) inputs, perform calculations/run algorithms (called Control loop/Control algorithm in this document) and write to outputs (typically PWM)</p>
<p> <style>div.image img[src="Fig2.PNG"]{width:80%}</style> </p><div class="image">
<img src="Fig2.PNG" alt=""/>
<div class="caption">
Various operations in Real Time Control interrupt</div></div>
<p>As shown in figure above, 5 operations are</p>
<ul>
<li><a class="el" href="OPTIMIZING_REAL_TIME_CONTROL_APPLICATIONS.html#CHAPTER_OPERATION_SECTION_1">Operation 1: Latch and respond to interrupt</a></li>
<li><a class="el" href="OPTIMIZING_REAL_TIME_CONTROL_APPLICATIONS.html#CHAPTER_OPERATION_SECTION_2">Operation 2: R5F Context save</a></li>
<li><a class="el" href="OPTIMIZING_REAL_TIME_CONTROL_APPLICATIONS.html#CHAPTER_OPERATION_SECTION_3">Operation 3: R5F read accesses to sensed inputs</a></li>
<li><a class="el" href="OPTIMIZING_REAL_TIME_CONTROL_APPLICATIONS.html#CHAPTER_OPERATION_SECTION_4">Operation 4: R5F executes calcuations/algorithm</a></li>
<li><a class="el" href="OPTIMIZING_REAL_TIME_CONTROL_APPLICATIONS.html#CHAPTER_OPERATION_SECTION_5">Operation 5: R5F writes to outputs</a></li>
</ul>
<p> <style>div.image img[src="Fig3.PNG"]{width:80%}</style> </p><div class="image">
<img src="Fig3.PNG" alt=""/>
<div class="caption">
Operation 2 to 5 in a typical application</div></div>
<p>Following sections show optimizations relevant for each operation performed in the Control loop ISR</p><ul>
<li>Description about the operation and performance consideration</li>
<li>Software and hardware optimization options</li>
</ul>
<h2><a class="anchor" id="CHAPTER_OPERATION_SECTION_1"></a>
Operation 1: Latch and respond to interrupt</h2>
<dl class="section note"><dt>Note</dt><dd>Latency to latch and repond to interrupt from ControlSS is 29 cycles (worst case) at 400MHz R5F core clock.</dd></dl>
<p>This latency depends on</p><ol type="1">
<li>Propagation of interrupt from peripheral to R5F. This is predominantly dependent on hardware latencies.</li>
<li>Instruction under execution in R5F. Worst case scenario is when R5F starts executing a multi-cycle instruction and unable to respond to the interrupt. Example: a memory load instruction (from OCRAM) under execution in background loop or a low priority task when expecting an ADC interrupt</li>
</ol>
<p>Optimization options:</p><ol type="1">
<li>ADC interrupt<ul>
<li>Use Early interrupt feature of ADC to triggers R5F interrupt ahead of completion of ADC conversion. Part of interrupt latency can be absorbed in ADC conversion latency</li>
</ul>
</li>
<li>EPWM interrupt<ul>
<li>Use Counter Compare to offset the EPWM interrupt</li>
</ul>
</li>
</ol>
<p> <style>div.image img[src="Fig4.PNG"]{width:80%}</style> </p><div class="image">
<img src="Fig4.PNG" alt=""/>
<div class="caption">
Interrupt route</div></div>
<h2><a class="anchor" id="CHAPTER_OPERATION_SECTION_2"></a>
Operation 2: R5F Context save</h2>
<dl class="section note"><dt>Note</dt><dd>Latency to save context is 53 cycles (best case) at 400MHz R5F core clock.</dd></dl>
<p>This latency depends on</p><ol type="1">
<li>Saving/preserving the context of interrupted task<ul>
<li>R5F Program status register, LR, core registers</li>
<li>This latency is predominantly dependent on software/compiler generated code.</li>
</ul>
</li>
<li>Support for floating point in the interrupt routine<ul>
<li>VFP control status: FPEXC, FPSCR, VFP double-precision float: D0-D7</li>
</ul>
</li>
<li>Support for nesting of interrupts</li>
</ol>
<p>Refer <a class="el" href="OPTIMIZING_APPLICATIONS_WITH_MCU_SDK.html#CHAPTER_OPTIMIZATION">Optimizations</a> for list of optimization options and trade-offs for this operation.</p>
<p> <style>div.image img[src="Fig5.PNG"]{width:80%}</style> </p><div class="image">
<img src="Fig5.PNG" alt=""/>
<div class="caption">
Code for context save</div></div>
<p> <style>div.image img[src="Fig6.PNG"]{width:80%}</style> </p><div class="image">
<img src="Fig6.PNG" alt=""/>
<div class="caption">
Context save</div></div>
<h2><a class="anchor" id="CHAPTER_OPERATION_SECTION_3"></a>
Operation 3: R5F read accesses to sensed inputs</h2>
<dl class="section note"><dt>Note</dt><dd>Latency to read inputs (one 16-bit ADC result) is 18 cycles (best case) at 400MHz R5F core clock</dd></dl>
<p>This latency depends on</p><ol type="1">
<li>Hardware latency. ControlSS peripheral register read access</li>
<li>Software/code. Pattern of accessing the registers</li>
<li>Data type conversion (for example: int to float)</li>
</ol>
<p>For example: In motor control use cases, R5 reads 16bit ADC results, converts results to floating point values and writes the values to memory for further calculation</p>
<p>Optimization options and trade-offs:</p><ul>
<li>2 byte or 4 byte ADC read from R5F (a 32 bit core) involve same latency (18 cycles).<ul>
<li>So, as an optimization use consecutive ADC SOCs, so that that 2 16bit ADC results are stored consecutively in a 32bit register. This reduces 2 read accesses.</li>
<li>Refer below the code used to split the 32 bit result to 2 16 bit values</li>
</ul>
</li>
<li>For conversion to floating point, use R5 FPU.</li>
<li>Write to TCM (1 cycle) instead of L2 OCRAM</li>
<li>Alternate approach is to use DMA to bring the ADC results to TCM. This can absorb overheads for R5 to read ADC results.</li>
</ul>
<p> <style>div.image img[src="Fig7.PNG"]{width:80%}</style> </p><div class="image">
<img src="Fig7.PNG" alt=""/>
<div class="caption">
ADC read access optimization</div></div>
<h2><a class="anchor" id="CHAPTER_OPERATION_SECTION_4"></a>
Operation 4: R5F executes calcuations/algorithm</h2>
<dl class="section note"><dt>Note</dt><dd>Execution time of the control algorithm is specific to application use case. For example: Field Oriented Control computations for AM263X traction inverter executes for 985ns. Refer application note. SPRAD32 <a href="https://www.ti.com/lit/an/sprad32/sprad32.pdf">https://www.ti.com/lit/an/sprad32/sprad32.pdf</a></dd></dl>
<p>This depends on</p><ol type="1">
<li>Number of inputs and outputs required. For example: number of channels, phases, stages</li>
<li>Number of floating point/trigonometric calculations</li>
</ol>
<p>Optimization options and trade-offs:</p>
<ul>
<li><a class="el" href="OPTIMIZING_APPLICATIONS_WITH_MCU_SDK.html#CHAPTER_OPTIMIZATION_SECTION_2">Optimize memory placement</a></li>
<li><a class="el" href="OPTIMIZING_APPLICATIONS_WITH_MCU_SDK.html#CHAPTER_OPTIMIZATION_SECTION_4">Optimize compiler settings</a></li>
<li><a class="el" href="OPTIMIZING_APPLICATIONS_WITH_MCU_SDK.html#CHAPTER_OPTIMIZATION_SECTION_5">Optimize application code</a></li>
</ul>
<p> <style>div.image img[src="Fig8.PNG"]{width:80%}</style> </p><div class="image">
<img src="Fig8.PNG" alt=""/>
<div class="caption">
Execution time for FOC computation from SPRAD32</div></div>
<h2><a class="anchor" id="CHAPTER_OPERATION_SECTION_5"></a>
Operation 5: R5F writes to outputs</h2>
<dl class="section note"><dt>Note</dt><dd>Throughput to write outputs (For example: PWM compare values) is 2 cycles per write (best case) at 400MHz R5F core clock. Refer section CHAPTER_OPTIMIZATION_SECTION_3 on the settings to achieve this throughput.</dd></dl>
<p>This latency depends on</p><ol type="1">
<li>Hardware latency (write access latency)</li>
<li>Software/Generated code (pattern of read/write)<ul>
<li>Load from TCM consumes 1 R5 cycle. Store consumes 2 R5 cycles (1 bus cycle @200MHz).</li>
<li>So 3 cycles for read+write.</li>
</ul>
</li>
</ol>
<p>Optimization options and trade-offs:</p>
<ul>
<li><a class="el" href="OPTIMIZING_APPLICATIONS_WITH_MCU_SDK.html#CHAPTER_OPTIMIZATION_SECTION_4">Optimize compiler settings</a></li>
<li>Setup the PWM region as device memory (not strongly ordered). Refer section CHAPTER_OPTIMIZATION_SECTION_3. This helps to achiee 2 cycle write throughput.</li>
<li>Store all the PWM data (compare values for modulation) in TCM consecutively for quick access</li>
<li>Interleave reads and writes (interleave load and store instructions). TI ARM CLANG (used by SDK) supports this optimization<ul>
<li>When the PWM writes are posted writes, the 2nd unused cycle of store instruction can be used for next read operation. This reduces overall write throughput to 2 cycles</li>
</ul>
</li>
</ul>
<p> <style>div.image img[src="Fig9.PNG"]{width:80%}</style> </p><div class="image">
<img src="Fig9.PNG" alt=""/>
<div class="caption">
PWM write latency optimization</div></div>
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
