<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM263x MCU+ SDK: Enet CPSW Ether-Ring Real-time and LWIP Traffic Generator Application</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM263x MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM263x MCU+ SDK
   &#160;<span id="projectnumber">11.00.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('EXAMPLES_ENET_CPSW_ETHERRING_TRAFFICGEN.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Enet CPSW Ether-Ring Real-time and LWIP Traffic Generator Application </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md3075">Introduction</a></li>
<li class="level1"><a href="#autotoc_md3076">Ether-Ring overview</a></li>
<li class="level1"><a href="#autotoc_md3077">Traffic Profiles for Redundancy Traffic</a><ul><li class="level2"><a href="#autotoc_md3078">Transmit-Heavy(Profile-A)</a></li>
<li class="level2"><a href="#autotoc_md3079">Receive-Heavy(Profile-B)</a></li>
<li class="level2"><a href="#autotoc_md3080">Symmetric Traffic(Profile-C)</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md3081">LWIP background traffic</a><ul><li class="level2"><a href="#autotoc_md3082">Configuration to use LWIP traffic in Ring Topology</a><ul><li class="level3"><a href="#autotoc_md3083">SysConfig GUI tool configuration</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md3084">Latency Benchmarking</a></li>
<li class="level1"><a href="#autotoc_md3085">Measured Average and Maximum Latency</a></li>
<li class="level1"><a href="#autotoc_md3086">Configuration Parameters</a></li>
<li class="level1"><a href="#autotoc_md3087">Supported Combinations</a><ul><li class="level2"><a href="#autotoc_md3088">Ether-Ring TrafficGen Applciation Start Menu</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md3089">Steps to Run the Example</a><ul><li class="level2"><a href="#autotoc_md3090">Build the example</a></li>
<li class="level2"><a href="#autotoc_md3091">HW Setup</a></li>
<li class="level2"><a href="#autotoc_md3092">Run the example</a><ul><li class="level3"><a href="#autotoc_md3093">Basic Test</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md3094">Sample output</a></li>
<li class="level2"><a href="#autotoc_md3095">Troubleshooting issues</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md3096">See Also</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_examples_networking_enet_cpsw_etherring_trafficgen"></a></p>
<h1><a class="anchor" id="autotoc_md3075"></a>
Introduction</h1>
<p>This application illustrates the simultaneous configuration and usage of redundancy traffic (Real-time) and background LWIP traffic in the Ether-Ring topology. The Ether-ring TrafficGen application allows configuring traffic profiles such as Transmit Heavy, Receive Heavy, and Symmetric for redundancy traffic. Each node either acts as a TCP Server or TCP Client in the network, and LWIP traffic will be sent from the client to the server in the background.</p>
<p>The purpose of this application is to perform Latency benchmarking with different traffic profiles for redundancy traffic with LWIP running in the background. The idea is to calculate the Latency without depending on the PTP GET_CURRENT_TIMESTAMP. This is because the timestamp is not accurate due to the delay added by IOCTL calls and the PTP timestamp in the FIFO model.</p>
<p>This application enables both MAC ports by default and each node is connected to its neighbouring node in a loop. This application uses Ether-ring (‘802.1CB-like’) to support Packet Duplication, Ring Termination in Hardware and Duplicate Rejection in Software.</p>
<p>The example application opens two DMA TX channels and two DMA RX channels. The TX0 and RX0 DMA channels are dedicated to handling redundancy packets via the Ether-Ring Driver, ensuring reliable data transmission even in case of failures. The TX1 and RX1 DMA channels are reserved for LWIP Background traffic.</p>
<h1><a class="anchor" id="autotoc_md3076"></a>
Ether-Ring overview</h1>
<p>Please refer <b><a class="el" href="ETHERRING_OVERVIEW.html">here</a></b> for Ether-Ring overview</p>
<h1><a class="anchor" id="autotoc_md3077"></a>
Traffic Profiles for Redundancy Traffic</h1>
<p>The redundancy traffic is divided into 3 types to perform Latency benchmarking based on use case. The application can configure all the Zones in one of the following types by modifying the <code>gTrafficProfile</code> variable in the code:</p>
<ul>
<li><b>Transmit Heavy</b>: The redundancy traffic transmitted from the CPU is more compared to the traffic received by the CPU. This traffic type simulates the majority of Zonal controllers in Automotive, where multiple Ethernet streams are periodically sent to the "CENTRAL COMPUTE."</li>
<li><b>Receive Heavy</b>: The redundancy traffic received to the CPU is more compared to the traffic transmitted from CPU. This simulates the Zonal Controller where the streams received are more compared to the streams sent.</li>
<li><b>Symmetric Traffic</b>: This traffic type configures the zones to send and receive same data rate of Real-time ethernet traffic periodically.</li>
</ul>
<h2><a class="anchor" id="autotoc_md3078"></a>
Transmit-Heavy(Profile-A)</h2>
<div class="image">
<img src="tp1.PNG" alt="" width="55%"/>
<div class="caption">
Transmit Heavy Traffic profile with each nodes acting as transmitter and subsequent receiver of each stream </div></div>
<p>By default, the application configures the Traffic profile as "Transmit Heavy." The user can modify the configuration by changing the value of <code>gTrafficProfile</code> in the code (e.g., <code>gTrafficProfile = TRAFFIC_PROFILE_B;</code> for Receive Heavy) based on the use case.</p>
<h2><a class="anchor" id="autotoc_md3079"></a>
Receive-Heavy(Profile-B)</h2>
<div class="image">
<img src="tp2.PNG" alt="" width="55%"/>
<div class="caption">
Receive-Heavy Traffic with each nodes acting as transmitter and subsequent receiver of each stream </div></div>
<h2><a class="anchor" id="autotoc_md3080"></a>
Symmetric Traffic(Profile-C)</h2>
<div class="image">
<img src="tp3.PNG" alt="" width="55%"/>
<div class="caption">
Symmetric Traffic with each nodes acting as transmitter and subsequent receiver of each stream </div></div>
<h1><a class="anchor" id="autotoc_md3081"></a>
LWIP background traffic</h1>
<p>Redundancy packets use Multicast Destination address to reach the destination Node. Even when ALE source learning is enabled, the packets are not dropping on mac port due to proper port mask configuration per Multicast address. When redundant multicast packets are sent in the ring, the source learning of Unicast address will be updated on all the Nodes.</p>
<p>Due to this source learning, the LWIP ARP unicast packet will be dropped at the MAC port because the ALE (Address Lookup Engine) updates its forwarding table with the source MAC address of the redundant multicast packets, causing it to misroute subsequent unicast packets. As a result, running LWIP traffic in the background is not possible with the default ALE configuration.</p>
<p>When a wire is broken, only the neighboring nodes will detect the Link DOWN event. This application configures each zone to handle LWIP traffic in ring topology and user has to make the following configuration to handle wire-cut scenario for LWIP traffic:</p>
<ol type="1">
<li><b>Detect Link DOWN</b>: In the port status change callback (<code>EnetApp_portLinkStatusChangeCb()</code>), detect the Link DOWN event and trigger the broadcast mechanism.</li>
<li><b>Send Initial Broadcast Packet</b>: Send a broadcast packet from the neighboring nodes to inform all other nodes in the ring about the Link DOWN event. This packet should include:<ul>
<li>A special identifier in the payload to distinguish it from regular traffic.</li>
<li>The source MAC address used for LWIP traffic should be used to send broadcast packet also.</li>
</ul>
</li>
<li><b>Process Broadcast Packet</b>: When a node receives this broadcast packet, it should:<ul>
<li>Enable source learning for the MAC address included in the packet.</li>
<li>Update its ALE (Address Lookup Engine) table with the source MAC address.</li>
<li>Disable the "Ether-Ring LWIP Support" in SysConfig GUI tool to allow non-directed LWIP traffic.</li>
</ul>
</li>
<li><b>Send Secondary Broadcast Packet</b>: After enabling source learning, the node should send another broadcast packet with the same source MAC address. This ensures that the ALE table is updated across all nodes in the ring.</li>
<li><b>Use LWIP MAC Address</b>: Ensure that the MAC address used for these broadcast packets matches the one configured for LWIP traffic to maintain consistency.</li>
</ol>
<p>By following these steps, the ALE will correctly learn the source MAC address, and the network will recover from the wire-cut scenario without dropping packets.</p>
<h2><a class="anchor" id="autotoc_md3082"></a>
Configuration to use LWIP traffic in Ring Topology</h2>
<ul>
<li>Different sets of Host Mac address for LWIP Background traffic and Real-time traffic</li>
<li>Send the LWIP Traffic as directed packets either from Mac port 1 or Mac port 2 from all the Nodes</li>
</ul>
<h3><a class="anchor" id="autotoc_md3083"></a>
SysConfig GUI tool configuration</h3>
<p>Enable "Ether-Ring LWIP Support" per netif in SysConfig GUI tool to send LWIP Directed packets in Ring. </p><div class="image">
<img src="etherring_lwip_support.png" alt="" width="45%"/>
<div class="caption">
Ether-ring LWIP Support in SysConfig GUI tool </div></div>
<h1><a class="anchor" id="autotoc_md3084"></a>
Latency Benchmarking</h1>
<p>Irrespective of traffic type, the profiling is enabled by default for Real-time traffic sent from Node 0. The application adds the current timestamp (CPU Time) at the start of payload in the packet. Additionally, parameters like sequence number and source node ID are appended after the timestamp.</p>
<p>When a packet is received on the farthest node (Node 2) from Node 0, the Ethernet packet is echoed back without modifying the payload. Upon receiving the packet back at the source node (Node 0), the timestamp embedded in the payload is extracted and compared with the current time to calculate the round trip latency (RTL) for each packet. After sending "ENETAPP_PACKETS_SENT_PER_STREAM" packets, the application calculates the average, maximum latency and prints on the console.</p>
<p>As the Round Trip method is used to benchmark latency, the CPU time from source node is used to measure the packet transmit and receive time. Due to this, PTP synchronization is not needed for benchmarking latency.</p>
<h1><a class="anchor" id="autotoc_md3085"></a>
Measured Average and Maximum Latency</h1>
<p>Please refer <b><a class="el" href="enetlld_performance.html">here</a></b> for Ether-Ring performance</p>
<h1><a class="anchor" id="autotoc_md3086"></a>
Configuration Parameters</h1>
<p>Typically, the application's parameters in "etherring_trafficgen_config.h" that a developer may want to change are:</p>
<ul>
<li><b>ENETAPP_MAX_NODES_IN_RING</b> - Application configures the max nodes as 4 and but the user can choose to update the number of nodes in etherring.</li>
<li><b>ENETAPP_NUM_CLASSA_STREAMS</b> - The number of Class A Streams are configured as 3 for Transmit Heavy and Receive Heavy Traffic profiles.</li>
<li><b>ENETAPP_MAX_CLASSA_STREAMS</b> - By default maximum Class A Streams are configured as 3. User has to update it based on the "ENETAPP_NUM_CLASSA_STREAMS" configuration.</li>
<li><b>ENETAPP_ENABLE_TCP_BG_TRAFFIC</b> - Flag to enable or disable the Lwip background traffic.</li>
<li><b>ENETAPP_CLASSA_PAYLOAD_LENGTH</b> - Class A payload length is configured as 500 by default and user can update it to achieve the desired data rate.</li>
</ul>
<h1><a class="anchor" id="autotoc_md3087"></a>
Supported Combinations</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter  </th><th class="markdownTableHeadNone">Value   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">CPU + OS  </td><td class="markdownTableBodyNone">r5fss0-0_freertos   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Toolchain  </td><td class="markdownTableBodyNone">ti-arm-clang   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Boards  </td><td class="markdownTableBodyNone">am263x-lp   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Example folder  </td><td class="markdownTableBodyNone">source/networking/enet/core/examples/etherring_trafficgen   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md3088"></a>
Ether-Ring TrafficGen Applciation Start Menu</h2>
<p>The following helper options are also provided in the application's start menu to configure the each node uniquely in Etherring:</p>
<div class="fragment"><div class="line">===============================</div>
<div class="line">    EtherRing TrafficGen App    </div>
<div class="line">===============================</div>
<div class="line">0 - Central Compute Node</div>
<div class="line">1 - Zone Left Node</div>
<div class="line">2 - Zone Right Node</div>
<div class="line">3 - Zone Tail Node</div>
<div class="line">Enter the nodeId : </div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md3089"></a>
Steps to Run the Example</h1>
<h2><a class="anchor" id="autotoc_md3090"></a>
Build the example</h2>
<ul>
<li>When using CCS projects to build, import the CCS project for the required combination and build it using the CCS project menu (see <a class="el" href="CCS_PROJECTS_PAGE.html">Using SDK with CCS Projects</a>).</li>
<li>When using makefiles to build, note the required combination and build using make command (see <a class="el" href="MAKEFILE_BUILD_PAGE.html">Using SDK with Makefiles</a>)</li>
</ul>
<h2><a class="anchor" id="autotoc_md3091"></a>
HW Setup</h2>
<p>Make sure you have setup the EVM with cable connections as shown in below Diagram. In addition, follow the steps in the next section.</p>
<div class="image">
<img src="etherring_evm.png" alt="" width="30%"/>
<div class="caption">
Ether-Ring EVM Connections </div></div>
<h2><a class="anchor" id="autotoc_md3092"></a>
Run the example</h2>
<h3><a class="anchor" id="autotoc_md3093"></a>
Basic Test</h3>
<p>The simplest test that one can run with the ETHERRING example consists of:</p><ul>
<li>Configuring the each node uniquely in the Ether-ring Network using NodeId and real-time traffic profile to all the streams</li>
<li>After the configuration, the application sends and receives the real-time traffic and LWIP background traffic</li>
<li>Application measures the round trip latency If the profiling is enabled for that particular stream. It prints the Average and Maximum latency on the console for Node0.</li>
</ul>
<p>The steps to run this test are:</p>
<ul>
<li>Connect the MAC port as described in <b>HW Setup</b> section and configure the Nodes using UART Terminal.</li>
<li>Launch a CCS debug session and run the example executable, see <a class="el" href="CCS_LAUNCH_PAGE.html">CCS Launch, Load and Run</a>.</li>
<li>Application logs such as Traffic profile type and LWIP configuration. Sample logs are shown in the next section.</li>
<li>Configure the each node as mentioned in <b>Ether-Ring TrafficGen Applciation Start Menu</b> section using UART Terminal around the same time in all the Nodes to start the application and wait for <code>----------ETHERRING DEMONSTRATION COMPLETED----------</code> to be printed on UART Terminal.</li>
</ul>
<h2><a class="anchor" id="autotoc_md3094"></a>
Sample output</h2>
<div class="fragment"><div class="line">===============================</div>
<div class="line">    EtherRing TrafficGen App    </div>
<div class="line">===============================</div>
<div class="line">0 - Central Compute Node</div>
<div class="line">1 - Zone Left Node</div>
<div class="line">2 - Zone Right Node</div>
<div class="line">3 - Zone Tail Node</div>
<div class="line">Enter the nodeId : </div>
<div class="line">0</div>
<div class="line">Create RX task for redundancy Traffic</div>
<div class="line">start to open driver.</div>
<div class="line"> </div>
<div class="line">Init all configs</div>
<div class="line">----------------------------------------------</div>
<div class="line">Open MAC port 1</div>
<div class="line">EnetPhy_bindDriver:1873 </div>
<div class="line">Open MAC port 2</div>
<div class="line">EnetPhy_bindDriver:1873 </div>
<div class="line">PHY 3 is alive</div>
<div class="line">PHY 12 is alive</div>
<div class="line">initQs() txFreePktInfoQ initialized with 48 pkts</div>
<div class="line">MAC port addr: 70:ff:76:1e:60:e0</div>
<div class="line">Rx Traffic Handler started</div>
<div class="line">Starting lwIP, local interface IP is dhcp-enabled</div>
<div class="line">[LWIPIF_LWIP] NETIF INIT SUCCESS</div>
<div class="line">Host MAC address-0 : 34:08:e1:84:dd:31</div>
<div class="line">Enet IF UP Event. Local interface IP:192.168.1.100</div>
<div class="line">[LWIPIF_LWIP] Enet has been started successfully</div>
<div class="line">Waiting for network UP ...</div>
<div class="line">Waiting for network UP ...</div>
<div class="line">Cpsw_handleLinkUp:1653 </div>
<div class="line">MAC Port 1: link up</div>
<div class="line">Network Link UP Event</div>
<div class="line">Cpsw_handleLinkUp:1653 </div>
<div class="line">MAC Port 2: link up</div>
<div class="line">Network is UP ...</div>
<div class="line">Acts as TCP Server</div>
<div class="line">Redundancy Traffic Task Creation </div>
<div class="line">Listening on 192.168.1.100:8888</div>
<div class="line">accepted new connection 70079280</div>
<div class="line"> </div>
<div class="line">********Ether-Ring Demonstration Completed********</div>
<div class="line">Average Latency: 44 us</div>
<div class="line">Maximum Latency: 94 us</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md3095"></a>
Troubleshooting issues</h2>
<h1><a class="anchor" id="autotoc_md3096"></a>
See Also</h1>
<p><a class="el" href="NETWORKING.html">Ethernet And Networking</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
